

<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">

  <link rel="stylesheet" href="/trustweave/assets/css/just-the-docs-default.css">

  <link rel="stylesheet" href="/trustweave/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet">

  <style id="jtd-nav-activation">
  
    .site-nav ul li a {
      background-image: none;
    }

  </style>

  

  
    <script src="/trustweave/assets/js/vendor/lunr.min.js"></script>
  

  <script src="/trustweave/assets/js/just-the-docs.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  



  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Advanced Features Implementation Plan | TrustWeave Developer Documentation</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Advanced Features Implementation Plan" />
<meta name="author" content="GeoKnoesis" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Comprehensive developer documentation for TrustWeave - A neutral, reusable trust and identity core library for Kotlin" />
<meta property="og:description" content="Comprehensive developer documentation for TrustWeave - A neutral, reusable trust and identity core library for Kotlin" />
<link rel="canonical" href="http://localhost:4000/trustweave/features/credential-exchange-protocols/ADVANCED_FEATURES_IMPLEMENTATION_PLAN/" />
<meta property="og:url" content="http://localhost:4000/trustweave/features/credential-exchange-protocols/ADVANCED_FEATURES_IMPLEMENTATION_PLAN/" />
<meta property="og:site_name" content="TrustWeave Developer Documentation" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Advanced Features Implementation Plan" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"GeoKnoesis"},"description":"Comprehensive developer documentation for TrustWeave - A neutral, reusable trust and identity core library for Kotlin","headline":"Advanced Features Implementation Plan","url":"http://localhost:4000/trustweave/features/credential-exchange-protocols/ADVANCED_FEATURES_IMPLEMENTATION_PLAN/"}</script>
<!-- End Jekyll SEO tag -->


  <!-- Main Navigation Styles - Consistent across all pages -->
<style>
  :root {
    --primary: #2563eb;
    --primary-dark: #1e40af;
    --secondary: #7c3aed;
    --accent: #10b981;
    --text: #1f2937;
    --text-light: #6b7280;
    --bg: #ffffff;
    --bg-light: #f9fafb;
    --border: #e5e7eb;
    --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  .main-nav {
    position: fixed;
    top: 0;
    width: 100%;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border);
    z-index: 1000;
    padding: 0.5rem 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  }
  
  .main-nav .nav-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .main-nav .logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    text-decoration: none;
    transition: opacity 0.3s;
  }

  .main-nav .logo-img {
    height: 120px;
    width: auto;
    transition: opacity 0.3s;
    display: block;
  }

  .main-nav .logo-img:not([src]),
  .main-nav .logo-img[src=""],
  .main-nav .logo-img[src*="undefined"] {
    display: none;
  }


  .main-nav .logo:hover {
    opacity: 0.8;
  }

  .main-nav .logo:hover .logo-img {
    opacity: 0.8;
  }
  
  .main-nav .nav-links {
    display: flex;
    gap: 1.5rem;
    align-items: center;
  }
  
  .main-nav .nav-links .nav-link {
    text-decoration: none;
    color: var(--text);
    font-weight: 500;
    font-size: 0.95rem;
    padding: 0.5rem 0;
    transition: color 0.3s;
    position: relative;
    white-space: nowrap;
  }
  
  .main-nav .nav-links .nav-link:hover {
    color: var(--primary);
  }

  .main-nav .nav-links .nav-link::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 2px;
    background: var(--primary);
    transition: width 0.3s ease;
  }

  .main-nav .nav-links .nav-link:hover::after,
  .main-nav .nav-links .nav-link.active::after {
    width: 100%;
  }

  .main-nav .nav-links .nav-link.active {
    color: var(--primary);
    font-weight: 600;
  }

  /* GitHub icon button */
  .main-nav .nav-links .github-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    border-radius: 0.5rem;
    transition: all 0.3s;
    padding: 0.5rem;
    color: var(--text);
    text-decoration: none;
    margin-left: 0.5rem;
  }

  .main-nav .nav-links .github-icon:hover {
    background: var(--bg-light);
    transform: translateY(-2px);
    color: var(--primary);
  }

  .main-nav .nav-links .github-icon svg {
    width: 32px;
    height: 32px;
  }

  /* Mobile menu toggle */
  .menu-toggle {
    display: none;
    flex-direction: column;
    cursor: pointer;
    gap: 5px;
    padding: 0.5rem;
    z-index: 1001;
  }

  .menu-toggle span {
    width: 25px;
    height: 3px;
    background: var(--text);
    transition: all 0.3s;
    border-radius: 2px;
  }

  .menu-toggle.active span:nth-child(1) {
    transform: rotate(45deg) translate(8px, 8px);
  }

  .menu-toggle.active span:nth-child(2) {
    opacity: 0;
  }

  .menu-toggle.active span:nth-child(3) {
    transform: rotate(-45deg) translate(7px, -7px);
  }

  /* Footer styles */
  .site-footer {
    background: var(--text);
    color: white;
    padding: 3rem 2rem;
    text-align: center;
    margin-top: 4rem;
  }

  .site-footer .footer-content {
    max-width: 1200px;
    margin: 0 auto;
  }

  .site-footer .footer-links {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .site-footer .footer-links a {
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    transition: color 0.3s;
  }

  .site-footer .footer-links a:hover {
    color: white;
  }

  .site-footer .footer-text {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.875rem;
  }

  /* Adjust content for fixed nav */
  body {
    padding-top: 160px;
  }

  /* Just the Docs theme adjustments */
  .site-header {
    margin-top: 0 !important;
  }

  /* Mobile responsive */
  @media (max-width: 968px) {
    .menu-toggle {
      display: flex;
    }

    .main-nav .nav-links {
      position: fixed;
      top: 160px;
      left: 0;
      right: 0;
      background: white;
      flex-direction: column;
      padding: 2rem;
      border-bottom: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(-100%);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      gap: 1.5rem;
      align-items: flex-start;
      max-height: calc(100vh - 160px);
      overflow-y: auto;
    }

    .main-nav .nav-links.active {
      transform: translateY(0);
      opacity: 1;
      visibility: visible;
    }

    .main-nav .nav-links .nav-link {
      width: 100%;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border);
    }

    .main-nav .nav-links .nav-link::after {
      display: none;
    }

    .main-nav .nav-links .github-icon {
      width: 100%;
      justify-content: flex-start;
      margin-left: 0;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border);
    }

    .main-nav .logo-img {
      height: 120px;
    }

    .site-footer .footer-links {
      flex-direction: column;
      gap: 1rem;
    }
  }

  /* Tablet adjustments */
  @media (max-width: 968px) and (min-width: 769px) {
    .main-nav .nav-links {
      gap: 1rem;
    }

    .main-nav .nav-links .nav-link {
      font-size: 0.9rem;
    }
  }
</style>

<style>
  body { padding-top: 160px !important; }
  .main-nav { z-index: 1000; position: fixed; top: 0; width: 100%; }
  #header-template { display: none; }
  
  /* Ensure footer spans full width and breaks out of containers */
  .site-footer {
    position: relative !important;
    width: 100vw !important;
    max-width: 100vw !important;
    margin-left: calc(-50vw + 50%) !important;
    margin-right: calc(-50vw + 50%) !important;
    left: 0 !important;
    right: 0 !important;
    clear: both !important;
    z-index: 100 !important;
    box-sizing: border-box !important;
  }
</style>
<!-- Hidden template for header injection -->
<div id="header-template" style="display: none;">
  <!-- Site Header - Consistent across all pages -->
<nav class="main-nav">
    <div class="nav-container">
        <a href="/trustweave/" class="logo">
            <img src="/trustweave/assets/images/trustweave-logo.jpg" alt="TrustWeave Logo" class="logo-img">
        </a>
        <div class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="nav-links" id="navLinks">
            <a href="/trustweave/" class="nav-link">Home</a>
            <a href="/trustweave/#features" class="nav-link">Features</a>
            <a href="/trustweave/use-scenarios/" class="nav-link">Use Scenarios</a>
            <a href="/trustweave/getting-started/README/" class="nav-link">Docs</a>
            <a href="/trustweave/partnership/" class="nav-link">Partners</a>
            <a href="/trustweave/about/" class="nav-link">About</a>
            <a href="https://github.com/geoknoesis/TrustWeave" target="_blank" rel="noopener noreferrer" class="github-icon" title="View on GitHub" aria-label="GitHub Repository">
                <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
            </a>
        </div>
    </div>
</nav>
<script>
    // Mobile menu toggle and active page highlighting
    (function() {
        const menuToggle = document.getElementById('menuToggle');
        const navLinks = document.getElementById('navLinks');
        
        // Mobile menu toggle
        if (menuToggle && navLinks) {
            menuToggle.addEventListener('click', () => {
                navLinks.classList.toggle('active');
                menuToggle.classList.toggle('active');
            });
            
            // Close menu when clicking on a link
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.addEventListener('click', () => {
                    navLinks.classList.remove('active');
                    menuToggle.classList.remove('active');
                });
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!menuToggle.contains(e.target) && !navLinks.contains(e.target)) {
                    navLinks.classList.remove('active');
                    menuToggle.classList.remove('active');
                }
            });
        }

        // Highlight active page
        const currentPath = window.location.pathname;
        const navLinksList = document.querySelectorAll('.nav-links .nav-link');
        
        navLinksList.forEach(link => {
            try {
                const linkUrl = new URL(link.href, window.location.origin);
                const linkPath = linkUrl.pathname;
                const baseUrl = '/trustweave' || '';
                
                // Normalize paths
                let cleanCurrentPath = currentPath.replace(baseUrl, '').replace(/\/$/, '') || '/';
                let cleanLinkPath = linkPath.replace(baseUrl, '').replace(/\/$/, '') || '/';
                
                // Handle index pages
                if (cleanCurrentPath === '' || cleanCurrentPath === '/index.html') cleanCurrentPath = '/';
                if (cleanLinkPath === '' || cleanLinkPath === '/index.html') cleanLinkPath = '/';
                
                // Check if current path matches link path
                if (cleanCurrentPath === cleanLinkPath) {
                    link.classList.add('active');
                } else if (cleanLinkPath !== '/' && cleanCurrentPath.startsWith(cleanLinkPath + '/')) {
                    // Handle sub-pages (e.g., /introduction/ matches /introduction/README/)
                    link.classList.add('active');
                }
            } catch (e) {
                // Fallback for relative URLs or errors
                const href = link.getAttribute('href');
                if (href && (currentPath.includes(href) || (href === '/' && currentPath.endsWith('index.html')))) {
                    link.classList.add('active');
                }
            }
        });
    })();
</script>


</div>
<script>
  // Move header from template to body top
  document.addEventListener('DOMContentLoaded', function() {
    const template = document.getElementById('header-template');
    if (template) {
      const header = template.querySelector('.main-nav');
      if (header) {
        document.body.insertBefore(header, document.body.firstChild);
        template.remove();
      }
    }
  });
</script>


</head>

<body>
  <a class="skip-to-main" href="#main-content">Skip to main content</a>
  <svg xmlns="http://www.w3.org/2000/svg" class="d-none">
  <symbol id="svg-link" viewBox="0 0 24 24">
  <title>Link</title>
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link">
    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
  </svg>
</symbol>

  <symbol id="svg-menu" viewBox="0 0 24 24">
  <title>Menu</title>
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
    <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
  </svg>
</symbol>

  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
  <title>Expand</title>
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
    <polyline points="9 18 15 12 9 6"></polyline>
  </svg>
</symbol>

  <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE -->
<symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link">
  <title id="svg-external-link-title">(external link)</title>
  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line>
</symbol>

  
    <symbol id="svg-doc" viewBox="0 0 24 24">
  <title>Document</title>
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file">
    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline>
  </svg>
</symbol>

    <symbol id="svg-search" viewBox="0 0 24 24">
  <title>Search</title>
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search">
    <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
  </svg>
</symbol>

  
  
    <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md -->
<symbol id="svg-copy" viewBox="0 0 16 16">
  <title>Copy</title>
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
    <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
    <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
  </svg>
</symbol>
<symbol id="svg-copied" viewBox="0 0 16 16">
  <title>Copied</title>
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16">
    <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/>
    <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/>
  </svg>
</symbol>

  
</svg>

  
    <div class="side-bar">
  <div class="site-header" role="banner">
    <a href="/trustweave/" class="site-title lh-tight">
  TrustWeave Developer Documentation

</a>
    <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false">
      <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg>
    </button>
  </div>

  <nav aria-label="Main" id="site-nav" class="site-nav">
  
  
    <ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Introduction category" aria-pressed="false">
        <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg>
      </button><a href="/trustweave/introduction/README/" class="nav-list-link">Introduction</a><ul class="nav-list"><li class="nav-list-item"><a href="/trustweave/introduction/what-is-trustweave/" class="nav-list-link">What is TrustWeave?</a></li><li class="nav-list-item"><a href="/trustweave/introduction/executive-overview/" class="nav-list-link">Executive Overview: TrustWeave</a></li><li class="nav-list-item"><a href="/trustweave/introduction/key-features/" class="nav-list-link">Key Features</a></li><li class="nav-list-item"><a href="/trustweave/introduction/use-cases/" class="nav-list-link">Use Cases</a></li><li class="nav-list-item"><a href="/trustweave/introduction/architecture-overview/" class="nav-list-link">Architecture Overview</a></li><li class="nav-list-item"><a href="/trustweave/introduction/mental-model/" class="nav-list-link">TrustWeave Mental Model</a></li><li class="nav-list-item"><a href="/trustweave/introduction/web-of-trust/" class="nav-list-link">The Web of Trust: Foundation for Decentralized Trust</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Getting Started category" aria-pressed="false">
        <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg>
      </button><a href="/trustweave/getting-started/README/" class="nav-list-link">Getting Started</a><ul class="nav-list"><li class="nav-list-item"><a href="/trustweave/getting-started/installation/" class="nav-list-link">Installation</a></li><li class="nav-list-item"><a href="/trustweave/getting-started/quick-start/" class="nav-list-link">Quick Start</a></li><li class="nav-list-item"><a href="/trustweave/getting-started/your-first-application/" class="nav-list-link">Your First Application</a></li><li class="nav-list-item"><a href="/trustweave/getting-started/project-setup/" class="nav-list-link">Project Setup</a></li><li class="nav-list-item"><a href="/trustweave/getting-started/ide-setup/" class="nav-list-link">IDE Setup Guide</a></li><li class="nav-list-item"><a href="/trustweave/getting-started/common-patterns/" class="nav-list-link">Common Patterns</a></li><li class="nav-list-item"><a href="/trustweave/getting-started/api-patterns/" class="nav-list-link">API Patterns and Best Practices</a></li><li class="nav-list-item"><a href="/trustweave/getting-started/workflows/" class="nav-list-link">Common Workflows</a></li><li class="nav-list-item"><a href="/trustweave/getting-started/dsl-guide/" class="nav-list-link">TrustWeave DSL Guide</a></li><li class="nav-list-item"><a href="/trustweave/getting-started/troubleshooting/" class="nav-list-link">Troubleshooting Guide</a></li><li class="nav-list-item"><a href="/trustweave/getting-started/production-deployment/" class="nav-list-link">Production Deployment Guide</a></li></ul></li><li class="nav-list-item"><a href="/trustweave/tutorials/README/" class="nav-list-link">Tutorials</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in How-To Guides category" aria-pressed="false">
        <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg>
      </button><a href="/trustweave/how-to/README/" class="nav-list-link">How-To Guides</a><ul class="nav-list"><li class="nav-list-item"><a href="/trustweave/how-to/create-dids/" class="nav-list-link">Create and Manage DIDs</a></li><li class="nav-list-item"><a href="/trustweave/how-to/issue-credentials/" class="nav-list-link">Issue Credentials</a></li><li class="nav-list-item"><a href="/trustweave/how-to/verify-credentials/" class="nav-list-link">Verify Credentials</a></li><li class="nav-list-item"><a href="/trustweave/how-to/manage-wallets/" class="nav-list-link">Manage Wallets</a></li><li class="nav-list-item"><a href="/trustweave/how-to/blockchain-anchoring/" class="nav-list-link">Anchor to Blockchain</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Core Concepts category" aria-pressed="false">
        <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg>
      </button><a href="/trustweave/core-concepts/README/" class="nav-list-link">Core Concepts</a><ul class="nav-list"><li class="nav-list-item"><a href="/trustweave/core-concepts/dids/" class="nav-list-link">Decentralized Identifiers (DIDs)</a></li><li class="nav-list-item"><a href="/trustweave/core-concepts/verifiable-credentials/" class="nav-list-link">Verifiable Credentials (VCs)</a></li><li class="nav-list-item"><a href="/trustweave/core-concepts/wallets/" class="nav-list-link">Wallets</a></li><li class="nav-list-item"><a href="/trustweave/core-concepts/blockchain-anchoring/" class="nav-list-link">Blockchain Anchoring</a></li><li class="nav-list-item"><a href="/trustweave/core-concepts/smart-contracts/" class="nav-list-link">Smart Contracts</a></li><li class="nav-list-item"><a href="/trustweave/core-concepts/key-management/" class="nav-list-link">Key Management</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in API Reference category" aria-pressed="false">
        <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg>
      </button><a href="/trustweave/api-reference/README/" class="nav-list-link">API Reference</a><ul class="nav-list"><li class="nav-list-item"><a href="/trustweave/api-reference/quick-reference/" class="nav-list-link">Quick Reference</a></li><li class="nav-list-item"><a href="/trustweave/api-reference/error-types/" class="nav-list-link">Error Types</a></li><li class="nav-list-item"><a href="/trustweave/api-reference/data-types/" class="nav-list-link">Data Types</a></li><li class="nav-list-item"><a href="/trustweave/api-reference/core-api/" class="nav-list-link">Core API Reference</a></li><li class="nav-list-item"><a href="/trustweave/api-reference/wallet-api/" class="nav-list-link">Wallet API Reference</a></li><li class="nav-list-item"><a href="/trustweave/api-reference/credential-service-api/" class="nav-list-link">Credential Service API Reference</a></li><li class="nav-list-item"><a href="/trustweave/api-reference/smart-contract-api/" class="nav-list-link">Smart Contract API Reference</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Reference category" aria-pressed="false">
        <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg>
      </button><a href="/trustweave/reference/README/" class="nav-list-link">Reference</a><ul class="nav-list"><li class="nav-list-item"><a href="/trustweave/modules/core-modules/" class="nav-list-link">Core Modules</a></li><li class="nav-list-item"><a href="/trustweave/faq/" class="nav-list-link">Frequently Asked Questions</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Advanced Topics category" aria-pressed="false">
        <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg>
      </button><a href="/trustweave/advanced/README/" class="nav-list-link">Advanced Topics</a><ul class="nav-list"><li class="nav-list-item"><a href="/trustweave/advanced/error-handling/" class="nav-list-link">Error Handling</a></li></ul></li><li class="nav-list-item"><a href="/trustweave/integrations/README/" class="nav-list-link">Integration Modules</a></li><li class="nav-list-item"><a href="/trustweave/contributing/README/" class="nav-list-link">Contributing to TrustWeave</a></li></ul>
  
</nav>




  
  
    <footer class="site-footer">
      This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.
    </footer>
  
</div>

  
  <div class="main" id="top">
    <div id="main-header" class="main-header">
  
    

<div class="search" role="search">
  <div class="search-input-wrap">
    <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search TrustWeave Developer Documentation" aria-label="Search TrustWeave Developer Documentation" autocomplete="off">
    <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label>
  </div>
  <div id="search-results" class="search-results"></div>
</div>

  
  
  
</div>

    <div class="main-content-wrap">
      
      <div id="main-content" class="main-content">
        <main>
          
            <h1 id="advanced-features-implementation-plan">
  
  
    <a href="#advanced-features-implementation-plan" class="anchor-heading" aria-labelledby="advanced-features-implementation-plan"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Advanced Features Implementation Plan
  
  
</h1>
    
<h2 id="overview">
  
  
    <a href="#overview" class="anchor-heading" aria-labelledby="overview"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview
  
  
</h2>
    

<p>This document outlines the implementation plan for advanced features to enhance the DIDComm message storage and SecretResolver system for production use.</p>
<h2 id="implementation-phases">
  
  
    <a href="#implementation-phases" class="anchor-heading" aria-labelledby="implementation-phases"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Implementation Phases
  
  
</h2>
    
<h3 id="phase-1-core-enhancements-priority-high">
  
  
    <a href="#phase-1-core-enhancements-priority-high" class="anchor-heading" aria-labelledby="phase-1-core-enhancements-priority-high"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Phase 1: Core Enhancements (Priority: High)
  
  
</h3>
    
<ol>
  <li>EncryptedFileLocalKeyStore implementation</li>
  <li>Message encryption at rest</li>
  <li>MongoDB storage implementation</li>
</ol>
<h3 id="phase-2-scalability--reliability-priority-high">
  
  
    <a href="#phase-2-scalability--reliability-priority-high" class="anchor-heading" aria-labelledby="phase-2-scalability--reliability-priority-high"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Phase 2: Scalability &amp; Reliability (Priority: High)
  
  
</h3>
    
<ol>
  <li>Message archiving to cold storage</li>
  <li>Message replication for high availability</li>
</ol>
<h3 id="phase-3-advanced-features-priority-medium">
  
  
    <a href="#phase-3-advanced-features-priority-medium" class="anchor-heading" aria-labelledby="phase-3-advanced-features-priority-medium"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Phase 3: Advanced Features (Priority: Medium)
  
  
</h3>
    
<ol>
  <li>Advanced search capabilities</li>
  <li>Message analytics and reporting</li>
  <li>Key rotation automation</li>
</ol><hr />
<h2 id="1-encryptedfilelocalkeystore-implementation">
  
  
    <a href="#1-encryptedfilelocalkeystore-implementation" class="anchor-heading" aria-labelledby="1-encryptedfilelocalkeystore-implementation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. EncryptedFileLocalKeyStore Implementation
  
  
</h2>
    
<h3 id="overview-1">
  
  
    <a href="#overview-1" class="anchor-heading" aria-labelledby="overview-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview
  
  
</h3>
    
<p>Implement encrypted file-based storage for DIDComm keys, providing secure local key storage for production use.</p>
<h3 id="architecture">
  
  
    <a href="#architecture" class="anchor-heading" aria-labelledby="architecture"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Architecture
  
  
</h3>
    

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>EncryptedFileLocalKeyStore
    │
    ├── Key Encryption (AES-256-GCM)
    │   └── Master Key Derivation (PBKDF2/Argon2)
    │
    ├── File Format
    │   ├── Header (metadata, version, salt)
    │   └── Encrypted Key Blocks (one per key)
    │
    └── Key Management
        ├── Key Rotation
        ├── Backup/Restore
        └── Access Control
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h3 id="implementation-steps">
  
  
    <a href="#implementation-steps" class="anchor-heading" aria-labelledby="implementation-steps"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Implementation Steps
  
  
</h3>
    
<h4 id="step-1-create-encryption-utilities">
  
  
    <a href="#step-1-create-encryption-utilities" class="anchor-heading" aria-labelledby="step-1-create-encryption-utilities"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1: Create Encryption Utilities
  
  
</h4>
    
<p><strong>File</strong>: <code class="language-plaintext highlighter-rouge">credentials/plugins/didcomm/src/main/kotlin/com/trustweave/credential/didcomm/crypto/secret/encryption/KeyEncryption.kt</code></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="nn">com.trustweave.credential.didcomm.crypto.secret.encryption</span>

<span class="k">import</span> <span class="nn">javax.crypto.Cipher</span>
<span class="k">import</span> <span class="nn">javax.crypto.spec.GCMParameterSpec</span>
<span class="k">import</span> <span class="nn">javax.crypto.spec.SecretKeySpec</span>
<span class="k">import</span> <span class="nn">java.security.SecureRandom</span>
<span class="k">import</span> <span class="nn">java.security.spec.KeySpec</span>
<span class="k">import</span> <span class="nn">javax.crypto.SecretKeyFactory</span>
<span class="k">import</span> <span class="nn">javax.crypto.spec.PBEKeySpec</span>
<span class="k">import</span> <span class="nn">java.util.Base64</span>

<span class="cm">/**
 * Encrypts/decrypts keys using AES-256-GCM.
 */</span>
<span class="kd">class</span> <span class="nc">KeyEncryption</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">masterKey</span><span class="p">:</span> <span class="nc">ByteArray</span> <span class="c1">// Derived from user password/master key</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">algorithm</span> <span class="p">=</span> <span class="s">"AES/GCM/NoPadding"</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">keyLength</span> <span class="p">=</span> <span class="mi">256</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">ivLength</span> <span class="p">=</span> <span class="mi">12</span> <span class="c1">// 96 bits for GCM</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">tagLength</span> <span class="p">=</span> <span class="mi">128</span> <span class="c1">// 16 bytes</span>
    
    <span class="k">fun</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">plaintext</span><span class="p">:</span> <span class="nc">ByteArray</span><span class="p">):</span> <span class="nc">EncryptedData</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">iv</span> <span class="p">=</span> <span class="nc">ByteArray</span><span class="p">(</span><span class="n">ivLength</span><span class="p">).</span><span class="nf">apply</span> <span class="p">{</span>
            <span class="nc">SecureRandom</span><span class="p">().</span><span class="nf">nextBytes</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="kd">val</span> <span class="py">secretKey</span> <span class="p">=</span> <span class="nc">SecretKeySpec</span><span class="p">(</span><span class="n">masterKey</span><span class="p">,</span> <span class="s">"AES"</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">parameterSpec</span> <span class="p">=</span> <span class="nc">GCMParameterSpec</span><span class="p">(</span><span class="n">tagLength</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
        
        <span class="kd">val</span> <span class="py">cipher</span> <span class="p">=</span> <span class="nc">Cipher</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">(</span><span class="n">algorithm</span><span class="p">)</span>
        <span class="n">cipher</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="nc">Cipher</span><span class="p">.</span><span class="nc">ENCRYPT_MODE</span><span class="p">,</span> <span class="n">secretKey</span><span class="p">,</span> <span class="n">parameterSpec</span><span class="p">)</span>
        
        <span class="kd">val</span> <span class="py">ciphertext</span> <span class="p">=</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">doFinal</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="nc">EncryptedData</span><span class="p">(</span>
            <span class="n">iv</span> <span class="p">=</span> <span class="n">iv</span><span class="p">,</span>
            <span class="n">ciphertext</span> <span class="p">=</span> <span class="n">ciphertext</span><span class="p">,</span>
            <span class="n">algorithm</span> <span class="p">=</span> <span class="n">algorithm</span>
        <span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">fun</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">encrypted</span><span class="p">:</span> <span class="nc">EncryptedData</span><span class="p">):</span> <span class="nc">ByteArray</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">secretKey</span> <span class="p">=</span> <span class="nc">SecretKeySpec</span><span class="p">(</span><span class="n">masterKey</span><span class="p">,</span> <span class="s">"AES"</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">parameterSpec</span> <span class="p">=</span> <span class="nc">GCMParameterSpec</span><span class="p">(</span><span class="n">tagLength</span><span class="p">,</span> <span class="n">encrypted</span><span class="p">.</span><span class="n">iv</span><span class="p">)</span>
        
        <span class="kd">val</span> <span class="py">cipher</span> <span class="p">=</span> <span class="nc">Cipher</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">(</span><span class="n">algorithm</span><span class="p">)</span>
        <span class="n">cipher</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="nc">Cipher</span><span class="p">.</span><span class="nc">DECRYPT_MODE</span><span class="p">,</span> <span class="n">secretKey</span><span class="p">,</span> <span class="n">parameterSpec</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">doFinal</span><span class="p">(</span><span class="n">encrypted</span><span class="p">.</span><span class="n">ciphertext</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">data class</span> <span class="nc">EncryptedData</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">iv</span><span class="p">:</span> <span class="nc">ByteArray</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">ciphertext</span><span class="p">:</span> <span class="nc">ByteArray</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">algorithm</span><span class="p">:</span> <span class="nc">String</span>
<span class="p">)</span>

<span class="cm">/**
 * Derives master key from password using PBKDF2.
 */</span>
<span class="kd">object</span> <span class="nc">MasterKeyDerivation</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">deriveKey</span><span class="p">(</span>
        <span class="n">password</span><span class="p">:</span> <span class="nc">CharArray</span><span class="p">,</span>
        <span class="n">salt</span><span class="p">:</span> <span class="nc">ByteArray</span><span class="p">,</span>
        <span class="n">iterations</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">100000</span>
    <span class="p">):</span> <span class="nc">ByteArray</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">keySpec</span><span class="p">:</span> <span class="nc">KeySpec</span> <span class="p">=</span> <span class="nc">PBEKeySpec</span><span class="p">(</span>
            <span class="n">password</span><span class="p">,</span>
            <span class="n">salt</span><span class="p">,</span>
            <span class="n">iterations</span><span class="p">,</span>
            <span class="mi">256</span> <span class="c1">// Key length in bits</span>
        <span class="p">)</span>
        <span class="kd">val</span> <span class="py">keyFactory</span> <span class="p">=</span> <span class="nc">SecretKeyFactory</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">(</span><span class="s">"PBKDF2WithHmacSHA256"</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">secretKey</span> <span class="p">=</span> <span class="n">keyFactory</span><span class="p">.</span><span class="nf">generateSecret</span><span class="p">(</span><span class="n">keySpec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">secretKey</span><span class="p">.</span><span class="n">encoded</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h4 id="step-2-implement-file-format">
  
  
    <a href="#step-2-implement-file-format" class="anchor-heading" aria-labelledby="step-2-implement-file-format"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2: Implement File Format
  
  
</h4>
    
<p><strong>File</strong>: <code class="language-plaintext highlighter-rouge">credentials/plugins/didcomm/src/main/kotlin/com/trustweave/credential/didcomm/crypto/secret/EncryptedFileLocalKeyStore.kt</code></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="nn">com.trustweave.credential.didcomm.crypto.secret</span>

<span class="k">import</span> <span class="nn">com.trustweave.credential.didcomm.crypto.secret.encryption.*</span>
<span class="k">import</span> <span class="nn">kotlinx.coroutines.Dispatchers</span>
<span class="k">import</span> <span class="nn">kotlinx.coroutines.withContext</span>
<span class="k">import</span> <span class="nn">kotlinx.serialization.json.*</span>
<span class="k">import</span> <span class="nn">org.didcommx.didcomm.secret.Secret</span>
<span class="k">import</span> <span class="nn">java.io.File</span>
<span class="k">import</span> <span class="nn">java.io.FileInputStream</span>
<span class="k">import</span> <span class="nn">java.io.FileOutputStream</span>
<span class="k">import</span> <span class="nn">java.nio.file.Files</span>
<span class="k">import</span> <span class="nn">java.nio.file.attribute.PosixFilePermission</span>
<span class="k">import</span> <span class="nn">java.util.concurrent.locks.ReentrantReadWriteLock</span>
<span class="k">import</span> <span class="nn">kotlin.concurrent.read</span>
<span class="k">import</span> <span class="nn">kotlin.concurrent.write</span>

<span class="cm">/**
 * Encrypted file-based local key store for production use.
 * 
 * Stores keys in an encrypted file with the following format:
 * 
 * File Structure:
 * - Header (JSON): version, salt, algorithm, metadata
 * - Key Blocks (encrypted): Each key stored as encrypted JSON
 * 
 * Security:
 * - Keys encrypted with AES-256-GCM
 * - Master key derived from password using PBKDF2
 * - File permissions restricted (600 on Unix)
 * - Atomic writes for consistency
 */</span>
<span class="kd">class</span> <span class="nc">EncryptedFileLocalKeyStore</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">keyFile</span><span class="p">:</span> <span class="nc">File</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">masterKey</span><span class="p">:</span> <span class="nc">ByteArray</span><span class="p">,</span> <span class="c1">// Should be derived from password</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">keyEncryption</span><span class="p">:</span> <span class="nc">KeyEncryption</span> <span class="p">=</span> <span class="nc">KeyEncryption</span><span class="p">(</span><span class="n">masterKey</span><span class="p">)</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">LocalKeyStore</span> <span class="p">{</span>
    
    <span class="k">private</span> <span class="kd">val</span> <span class="py">lock</span> <span class="p">=</span> <span class="nc">ReentrantReadWriteLock</span><span class="p">()</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">json</span> <span class="p">=</span> <span class="nc">Json</span> <span class="p">{</span> <span class="n">prettyPrint</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span> <span class="n">encodeDefaults</span> <span class="p">=</span> <span class="k">false</span> <span class="p">}</span>
    
    <span class="nf">init</span> <span class="p">{</span>
        <span class="c1">// Ensure file exists and has correct permissions</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">keyFile</span><span class="p">.</span><span class="nf">exists</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">keyFile</span><span class="p">.</span><span class="nf">createNewFile</span><span class="p">()</span>
            <span class="nf">setSecurePermissions</span><span class="p">(</span><span class="n">keyFile</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">setSecurePermissions</span><span class="p">(</span><span class="n">keyFile</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">get</span><span class="p">(</span><span class="n">keyId</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">Secret</span><span class="p">?</span> <span class="p">=</span> <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lock</span><span class="p">.</span><span class="nf">read</span> <span class="p">{</span>
            <span class="kd">val</span> <span class="py">keys</span> <span class="p">=</span> <span class="nf">loadKeys</span><span class="p">()</span>
            <span class="n">keys</span><span class="p">[</span><span class="n">keyId</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">store</span><span class="p">(</span><span class="n">keyId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">secret</span><span class="p">:</span> <span class="nc">Secret</span><span class="p">)</span> <span class="p">=</span> <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lock</span><span class="p">.</span><span class="nf">write</span> <span class="p">{</span>
            <span class="kd">val</span> <span class="py">keys</span> <span class="p">=</span> <span class="nf">loadKeys</span><span class="p">().</span><span class="nf">toMutableMap</span><span class="p">()</span>
            <span class="n">keys</span><span class="p">[</span><span class="n">keyId</span><span class="p">]</span> <span class="p">=</span> <span class="n">secret</span>
            <span class="nf">saveKeys</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">delete</span><span class="p">(</span><span class="n">keyId</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">Boolean</span> <span class="p">=</span> <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lock</span><span class="p">.</span><span class="nf">write</span> <span class="p">{</span>
            <span class="kd">val</span> <span class="py">keys</span> <span class="p">=</span> <span class="nf">loadKeys</span><span class="p">().</span><span class="nf">toMutableMap</span><span class="p">()</span>
            <span class="kd">val</span> <span class="py">removed</span> <span class="p">=</span> <span class="n">keys</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">keyId</span><span class="p">)</span> <span class="p">!=</span> <span class="k">null</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">removed</span><span class="p">)</span> <span class="p">{</span>
                <span class="nf">saveKeys</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">removed</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">list</span><span class="p">():</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lock</span><span class="p">.</span><span class="nf">read</span> <span class="p">{</span>
            <span class="kd">val</span> <span class="py">keys</span> <span class="p">=</span> <span class="nf">loadKeys</span><span class="p">()</span>
            <span class="n">keys</span><span class="p">.</span><span class="n">keys</span><span class="p">.</span><span class="nf">toList</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">loadKeys</span><span class="p">():</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">Secret</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">keyFile</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="p">||</span> <span class="n">keyFile</span><span class="p">.</span><span class="nf">length</span><span class="p">()</span> <span class="p">==</span> <span class="mi">0L</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">emptyMap</span><span class="p">()</span>
        <span class="p">}</span>
        
        <span class="k">try</span> <span class="p">{</span>
            <span class="kd">val</span> <span class="py">fileContent</span> <span class="p">=</span> <span class="n">keyFile</span><span class="p">.</span><span class="nf">readBytes</span><span class="p">()</span>
            <span class="kd">val</span> <span class="py">encryptedData</span> <span class="p">=</span> <span class="nf">parseEncryptedFile</span><span class="p">(</span><span class="n">fileContent</span><span class="p">)</span>
            <span class="kd">val</span> <span class="py">decryptedContent</span> <span class="p">=</span> <span class="n">keyEncryption</span><span class="p">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="n">encryptedData</span><span class="p">)</span>
            <span class="kd">val</span> <span class="py">jsonString</span> <span class="p">=</span> <span class="nc">String</span><span class="p">(</span><span class="n">decryptedContent</span><span class="p">,</span> <span class="nc">Charsets</span><span class="p">.</span><span class="nc">UTF_8</span><span class="p">)</span>
            <span class="kd">val</span> <span class="py">keysJson</span> <span class="p">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">parseToJsonElement</span><span class="p">(</span><span class="n">jsonString</span><span class="p">).</span><span class="n">jsonObject</span>
            
            <span class="k">return</span> <span class="n">keysJson</span><span class="p">.</span><span class="n">entries</span><span class="p">.</span><span class="nf">associate</span> <span class="p">{</span> <span class="p">(</span><span class="n">keyId</span><span class="p">,</span> <span class="n">secretJson</span><span class="p">)</span> <span class="p">-&gt;</span>
                <span class="n">keyId</span> <span class="n">to</span> <span class="n">json</span><span class="p">.</span><span class="nf">decodeFromJsonElement</span><span class="p">(</span><span class="nc">Secret</span><span class="p">.</span><span class="nf">serializer</span><span class="p">(),</span> <span class="n">secretJson</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">Exception</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nc">IllegalStateException</span><span class="p">(</span><span class="s">"Failed to load keys from encrypted file"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">saveKeys</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">Secret</span><span class="p">&gt;)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="kd">val</span> <span class="py">keysJson</span> <span class="p">=</span> <span class="nf">buildJsonObject</span> <span class="p">{</span>
                <span class="n">keys</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span> <span class="p">(</span><span class="n">keyId</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span> <span class="p">-&gt;</span>
                    <span class="nf">put</span><span class="p">(</span><span class="n">keyId</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="nf">encodeToJsonElement</span><span class="p">(</span><span class="nc">Secret</span><span class="p">.</span><span class="nf">serializer</span><span class="p">(),</span> <span class="n">secret</span><span class="p">))</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="kd">val</span> <span class="py">jsonString</span> <span class="p">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">encodeToString</span><span class="p">(</span><span class="nc">JsonObject</span><span class="p">.</span><span class="nf">serializer</span><span class="p">(),</span> <span class="n">keysJson</span><span class="p">)</span>
            <span class="kd">val</span> <span class="py">plaintext</span> <span class="p">=</span> <span class="n">jsonString</span><span class="p">.</span><span class="nf">toByteArray</span><span class="p">(</span><span class="nc">Charsets</span><span class="p">.</span><span class="nc">UTF_8</span><span class="p">)</span>
            <span class="kd">val</span> <span class="py">encryptedData</span> <span class="p">=</span> <span class="n">keyEncryption</span><span class="p">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span>
            
            <span class="kd">val</span> <span class="py">fileContent</span> <span class="p">=</span> <span class="nf">serializeEncryptedFile</span><span class="p">(</span><span class="n">encryptedData</span><span class="p">)</span>
            
            <span class="c1">// Atomic write: write to temp file, then rename</span>
            <span class="kd">val</span> <span class="py">tempFile</span> <span class="p">=</span> <span class="nc">File</span><span class="p">(</span><span class="n">keyFile</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="s">"${keyFile.name}.tmp"</span><span class="p">)</span>
            <span class="n">tempFile</span><span class="p">.</span><span class="nf">writeBytes</span><span class="p">(</span><span class="n">fileContent</span><span class="p">)</span>
            <span class="nf">setSecurePermissions</span><span class="p">(</span><span class="n">tempFile</span><span class="p">)</span>
            
            <span class="c1">// Atomic rename</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">keyFile</span><span class="p">.</span><span class="nf">exists</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">keyFile</span><span class="p">.</span><span class="nf">delete</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">tempFile</span><span class="p">.</span><span class="nf">renameTo</span><span class="p">(</span><span class="n">keyFile</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">Exception</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nc">IllegalStateException</span><span class="p">(</span><span class="s">"Failed to save keys to encrypted file"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">parseEncryptedFile</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nc">ByteArray</span><span class="p">):</span> <span class="nc">EncryptedData</span> <span class="p">{</span>
        <span class="c1">// Parse file format:</span>
        <span class="c1">// [4 bytes: version][4 bytes: iv length][iv][ciphertext]</span>
        <span class="kd">var</span> <span class="py">offset</span> <span class="p">=</span> <span class="mi">0</span>
        
        <span class="kd">val</span> <span class="py">version</span> <span class="p">=</span> <span class="n">content</span><span class="p">.</span><span class="nf">sliceArray</span><span class="p">(</span><span class="n">offset</span> <span class="n">until</span> <span class="n">offset</span> <span class="p">+</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">offset</span> <span class="p">+=</span> <span class="mi">4</span>
        
        <span class="kd">val</span> <span class="py">ivLength</span> <span class="p">=</span> <span class="n">content</span><span class="p">.</span><span class="nf">sliceArray</span><span class="p">(</span><span class="n">offset</span> <span class="n">until</span> <span class="n">offset</span> <span class="p">+</span> <span class="mi">4</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">fold</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">acc</span><span class="p">,</span> <span class="n">byte</span> <span class="p">-&gt;</span> <span class="p">(</span><span class="n">acc</span> <span class="n">shl</span> <span class="mi">8</span><span class="p">)</span> <span class="nf">or</span> <span class="p">(</span><span class="n">byte</span><span class="p">.</span><span class="nf">toInt</span><span class="p">()</span> <span class="n">and</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">offset</span> <span class="p">+=</span> <span class="mi">4</span>
        
        <span class="kd">val</span> <span class="py">iv</span> <span class="p">=</span> <span class="n">content</span><span class="p">.</span><span class="nf">sliceArray</span><span class="p">(</span><span class="n">offset</span> <span class="n">until</span> <span class="n">offset</span> <span class="p">+</span> <span class="n">ivLength</span><span class="p">)</span>
        <span class="n">offset</span> <span class="p">+=</span> <span class="n">ivLength</span>
        
        <span class="kd">val</span> <span class="py">ciphertext</span> <span class="p">=</span> <span class="n">content</span><span class="p">.</span><span class="nf">sliceArray</span><span class="p">(</span><span class="n">offset</span> <span class="n">until</span> <span class="n">content</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="nc">EncryptedData</span><span class="p">(</span>
            <span class="n">iv</span> <span class="p">=</span> <span class="n">iv</span><span class="p">,</span>
            <span class="n">ciphertext</span> <span class="p">=</span> <span class="n">ciphertext</span><span class="p">,</span>
            <span class="n">algorithm</span> <span class="p">=</span> <span class="s">"AES/GCM/NoPadding"</span>
        <span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">serializeEncryptedFile</span><span class="p">(</span><span class="n">encrypted</span><span class="p">:</span> <span class="nc">EncryptedData</span><span class="p">):</span> <span class="nc">ByteArray</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">version</span> <span class="p">=</span> <span class="nf">byteArrayOf</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="c1">// Version 1</span>
        <span class="kd">val</span> <span class="py">ivLength</span> <span class="p">=</span> <span class="nf">byteArrayOf</span><span class="p">(</span>
            <span class="p">((</span><span class="n">encrypted</span><span class="p">.</span><span class="n">iv</span><span class="p">.</span><span class="n">size</span> <span class="n">shr</span> <span class="mi">24</span><span class="p">)</span> <span class="n">and</span> <span class="mh">0xFF</span><span class="p">).</span><span class="nf">toByte</span><span class="p">(),</span>
            <span class="p">((</span><span class="n">encrypted</span><span class="p">.</span><span class="n">iv</span><span class="p">.</span><span class="n">size</span> <span class="n">shr</span> <span class="mi">16</span><span class="p">)</span> <span class="n">and</span> <span class="mh">0xFF</span><span class="p">).</span><span class="nf">toByte</span><span class="p">(),</span>
            <span class="p">((</span><span class="n">encrypted</span><span class="p">.</span><span class="n">iv</span><span class="p">.</span><span class="n">size</span> <span class="n">shr</span> <span class="mi">8</span><span class="p">)</span> <span class="n">and</span> <span class="mh">0xFF</span><span class="p">).</span><span class="nf">toByte</span><span class="p">(),</span>
            <span class="p">(</span><span class="n">encrypted</span><span class="p">.</span><span class="n">iv</span><span class="p">.</span><span class="n">size</span> <span class="n">and</span> <span class="mh">0xFF</span><span class="p">).</span><span class="nf">toByte</span><span class="p">()</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">version</span> <span class="p">+</span> <span class="n">ivLength</span> <span class="p">+</span> <span class="n">encrypted</span><span class="p">.</span><span class="n">iv</span> <span class="p">+</span> <span class="n">encrypted</span><span class="p">.</span><span class="n">ciphertext</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">setSecurePermissions</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="nc">File</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// Set permissions to 600 (owner read/write only)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nc">System</span><span class="p">.</span><span class="nf">getProperty</span><span class="p">(</span><span class="s">"os.name"</span><span class="p">).</span><span class="nf">lowercase</span><span class="p">().</span><span class="nf">contains</span><span class="p">(</span><span class="s">"win"</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// Windows: Use Java NIO</span>
                <span class="n">file</span><span class="p">.</span><span class="nf">setReadable</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">)</span>
                <span class="n">file</span><span class="p">.</span><span class="nf">setWritable</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">)</span>
                <span class="n">file</span><span class="p">.</span><span class="nf">setReadable</span><span class="p">(</span><span class="k">true</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span>
                <span class="n">file</span><span class="p">.</span><span class="nf">setWritable</span><span class="p">(</span><span class="k">true</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// Unix: Use POSIX permissions</span>
                <span class="kd">val</span> <span class="py">perms</span> <span class="p">=</span> <span class="nf">setOf</span><span class="p">(</span>
                    <span class="nc">PosixFilePermission</span><span class="p">.</span><span class="nc">OWNER_READ</span><span class="p">,</span>
                    <span class="nc">PosixFilePermission</span><span class="p">.</span><span class="nc">OWNER_WRITE</span>
                <span class="p">)</span>
                <span class="nc">Files</span><span class="p">.</span><span class="nf">setPosixFilePermissions</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="nf">toPath</span><span class="p">(),</span> <span class="n">perms</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">Exception</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Ignore if permissions can't be set</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**
 * Factory for creating EncryptedFileLocalKeyStore with password.
 */</span>
<span class="kd">object</span> <span class="nc">EncryptedFileLocalKeyStoreFactory</span> <span class="p">{</span>
    <span class="cm">/**
     * Creates an encrypted file key store from a password.
     * 
     * @param keyFile File to store keys
     * @param password Password for encryption
     * @param salt Salt for key derivation (optional, will be generated)
     * @return EncryptedFileLocalKeyStore instance
     */</span>
    <span class="k">fun</span> <span class="nf">create</span><span class="p">(</span>
        <span class="n">keyFile</span><span class="p">:</span> <span class="nc">File</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nc">CharArray</span><span class="p">,</span>
        <span class="n">salt</span><span class="p">:</span> <span class="nc">ByteArray</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
    <span class="p">):</span> <span class="nc">EncryptedFileLocalKeyStore</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">actualSalt</span> <span class="p">=</span> <span class="n">salt</span> <span class="o">?:</span> <span class="nc">ByteArray</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nf">apply</span> <span class="p">{</span>
            <span class="n">java</span><span class="p">.</span><span class="n">security</span><span class="p">.</span><span class="nc">SecureRandom</span><span class="p">().</span><span class="nf">nextBytes</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="kd">val</span> <span class="py">masterKey</span> <span class="p">=</span> <span class="nc">MasterKeyDerivation</span><span class="p">.</span><span class="nf">deriveKey</span><span class="p">(</span>
            <span class="n">password</span> <span class="p">=</span> <span class="n">password</span><span class="p">,</span>
            <span class="n">salt</span> <span class="p">=</span> <span class="n">actualSalt</span><span class="p">,</span>
            <span class="n">iterations</span> <span class="p">=</span> <span class="mi">100000</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="nc">EncryptedFileLocalKeyStore</span><span class="p">(</span><span class="n">keyFile</span><span class="p">,</span> <span class="n">masterKey</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h3 id="testing-strategy">
  
  
    <a href="#testing-strategy" class="anchor-heading" aria-labelledby="testing-strategy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Testing Strategy
  
  
</h3>
    
<ul>
  <li>Unit tests for encryption/decryption</li>
  <li>Integration tests with file system</li>
  <li>Security tests for key access</li>
  <li>Performance tests for large key sets</li>
</ul>
<h3 id="dependencies">
  
  
    <a href="#dependencies" class="anchor-heading" aria-labelledby="dependencies"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Dependencies
  
  
</h3>
    
<ul>
  <li>BouncyCastle (already included)</li>
  <li>Kotlinx Serialization (already included)</li>
</ul><hr />
<h2 id="2-message-encryption-at-rest">
  
  
    <a href="#2-message-encryption-at-rest" class="anchor-heading" aria-labelledby="2-message-encryption-at-rest"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Message Encryption at Rest
  
  
</h2>
    
<h3 id="overview-2">
  
  
    <a href="#overview-2" class="anchor-heading" aria-labelledby="overview-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview
  
  
</h3>
    
<p>Encrypt message JSON in the database to protect sensitive data.</p>
<h3 id="architecture-1">
  
  
    <a href="#architecture-1" class="anchor-heading" aria-labelledby="architecture-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Architecture
  
  
</h3>
    

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>PostgresDidCommMessageStorage
    │
    ├── Encryption Layer
    │   ├── Field-level encryption (selective fields)
    │   └── Full message encryption (all messages)
    │
    └── Key Management
        ├── Encryption Key Rotation
        └── Key Versioning
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h3 id="implementation-steps-1">
  
  
    <a href="#implementation-steps-1" class="anchor-heading" aria-labelledby="implementation-steps-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Implementation Steps
  
  
</h3>
    
<h4 id="step-1-create-message-encryption-service">
  
  
    <a href="#step-1-create-message-encryption-service" class="anchor-heading" aria-labelledby="step-1-create-message-encryption-service"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1: Create Message Encryption Service
  
  
</h4>
    
<p><strong>File</strong>: <code class="language-plaintext highlighter-rouge">credentials/plugins/didcomm/src/main/kotlin/com/trustweave/credential/didcomm/storage/encryption/MessageEncryption.kt</code></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="nn">com.trustweave.credential.didcomm.storage.encryption</span>

<span class="k">import</span> <span class="nn">com.trustweave.credential.didcomm.models.DidCommMessage</span>
<span class="k">import</span> <span class="nn">kotlinx.serialization.json.*</span>
<span class="k">import</span> <span class="nn">javax.crypto.Cipher</span>
<span class="k">import</span> <span class="nn">javax.crypto.spec.GCMParameterSpec</span>
<span class="k">import</span> <span class="nn">javax.crypto.spec.SecretKeySpec</span>
<span class="k">import</span> <span class="nn">java.security.SecureRandom</span>
<span class="k">import</span> <span class="nn">java.util.Base64</span>

<span class="cm">/**
 * Encrypts/decrypts DIDComm messages at rest.
 * 
 * Supports:
 * - Full message encryption
 * - Field-level encryption (selective fields)
 * - Key rotation
 */</span>
<span class="kd">interface</span> <span class="nc">MessageEncryption</span> <span class="p">{</span>
    <span class="cm">/**
     * Encrypts a message for storage.
     */</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nc">DidCommMessage</span><span class="p">):</span> <span class="nc">EncryptedMessage</span>
    
    <span class="cm">/**
     * Decrypts a message from storage.
     */</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">encrypted</span><span class="p">:</span> <span class="nc">EncryptedMessage</span><span class="p">):</span> <span class="nc">DidCommMessage</span>
    
    <span class="cm">/**
     * Gets the current encryption key version.
     */</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getKeyVersion</span><span class="p">():</span> <span class="nc">Int</span>
<span class="p">}</span>

<span class="kd">data class</span> <span class="nc">EncryptedMessage</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">keyVersion</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">encryptedData</span><span class="p">:</span> <span class="nc">ByteArray</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">iv</span><span class="p">:</span> <span class="nc">ByteArray</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">algorithm</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">"AES-256-GCM"</span>
<span class="p">)</span>

<span class="cm">/**
 * AES-256-GCM implementation of message encryption.
 */</span>
<span class="kd">class</span> <span class="nc">AesMessageEncryption</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">encryptionKey</span><span class="p">:</span> <span class="nc">ByteArray</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">keyVersion</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">1</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">MessageEncryption</span> <span class="p">{</span>
    
    <span class="k">private</span> <span class="kd">val</span> <span class="py">algorithm</span> <span class="p">=</span> <span class="s">"AES/GCM/NoPadding"</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">ivLength</span> <span class="p">=</span> <span class="mi">12</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">tagLength</span> <span class="p">=</span> <span class="mi">128</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nc">DidCommMessage</span><span class="p">):</span> <span class="nc">EncryptedMessage</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">json</span> <span class="p">=</span> <span class="nc">Json</span> <span class="p">{</span> <span class="n">prettyPrint</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span> <span class="n">encodeDefaults</span> <span class="p">=</span> <span class="k">false</span> <span class="p">}</span>
        <span class="kd">val</span> <span class="py">messageJson</span> <span class="p">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">encodeToString</span><span class="p">(</span>
            <span class="nc">DidCommMessage</span><span class="p">.</span><span class="nf">serializer</span><span class="p">(),</span>
            <span class="n">message</span>
        <span class="p">)</span>
        <span class="kd">val</span> <span class="py">plaintext</span> <span class="p">=</span> <span class="n">messageJson</span><span class="p">.</span><span class="nf">toByteArray</span><span class="p">(</span><span class="nc">Charsets</span><span class="p">.</span><span class="nc">UTF_8</span><span class="p">)</span>
        
        <span class="kd">val</span> <span class="py">iv</span> <span class="p">=</span> <span class="nc">ByteArray</span><span class="p">(</span><span class="n">ivLength</span><span class="p">).</span><span class="nf">apply</span> <span class="p">{</span>
            <span class="nc">SecureRandom</span><span class="p">().</span><span class="nf">nextBytes</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="kd">val</span> <span class="py">secretKey</span> <span class="p">=</span> <span class="nc">SecretKeySpec</span><span class="p">(</span><span class="n">encryptionKey</span><span class="p">,</span> <span class="s">"AES"</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">parameterSpec</span> <span class="p">=</span> <span class="nc">GCMParameterSpec</span><span class="p">(</span><span class="n">tagLength</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
        
        <span class="kd">val</span> <span class="py">cipher</span> <span class="p">=</span> <span class="nc">Cipher</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">(</span><span class="n">algorithm</span><span class="p">)</span>
        <span class="n">cipher</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="nc">Cipher</span><span class="p">.</span><span class="nc">ENCRYPT_MODE</span><span class="p">,</span> <span class="n">secretKey</span><span class="p">,</span> <span class="n">parameterSpec</span><span class="p">)</span>
        
        <span class="kd">val</span> <span class="py">ciphertext</span> <span class="p">=</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">doFinal</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="nc">EncryptedMessage</span><span class="p">(</span>
            <span class="n">keyVersion</span> <span class="p">=</span> <span class="n">keyVersion</span><span class="p">,</span>
            <span class="n">encryptedData</span> <span class="p">=</span> <span class="n">ciphertext</span><span class="p">,</span>
            <span class="n">iv</span> <span class="p">=</span> <span class="n">iv</span><span class="p">,</span>
            <span class="n">algorithm</span> <span class="p">=</span> <span class="n">algorithm</span>
        <span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">encrypted</span><span class="p">:</span> <span class="nc">EncryptedMessage</span><span class="p">):</span> <span class="nc">DidCommMessage</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">secretKey</span> <span class="p">=</span> <span class="nc">SecretKeySpec</span><span class="p">(</span><span class="n">encryptionKey</span><span class="p">,</span> <span class="s">"AES"</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">parameterSpec</span> <span class="p">=</span> <span class="nc">GCMParameterSpec</span><span class="p">(</span><span class="n">tagLength</span><span class="p">,</span> <span class="n">encrypted</span><span class="p">.</span><span class="n">iv</span><span class="p">)</span>
        
        <span class="kd">val</span> <span class="py">cipher</span> <span class="p">=</span> <span class="nc">Cipher</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">(</span><span class="n">algorithm</span><span class="p">)</span>
        <span class="n">cipher</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="nc">Cipher</span><span class="p">.</span><span class="nc">DECRYPT_MODE</span><span class="p">,</span> <span class="n">secretKey</span><span class="p">,</span> <span class="n">parameterSpec</span><span class="p">)</span>
        
        <span class="kd">val</span> <span class="py">plaintext</span> <span class="p">=</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">doFinal</span><span class="p">(</span><span class="n">encrypted</span><span class="p">.</span><span class="n">encryptedData</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">jsonString</span> <span class="p">=</span> <span class="nc">String</span><span class="p">(</span><span class="n">plaintext</span><span class="p">,</span> <span class="nc">Charsets</span><span class="p">.</span><span class="nc">UTF_8</span><span class="p">)</span>
        
        <span class="kd">val</span> <span class="py">json</span> <span class="p">=</span> <span class="nc">Json</span> <span class="p">{</span> <span class="n">ignoreUnknownKeys</span> <span class="p">=</span> <span class="k">true</span> <span class="p">}</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">decodeFromString</span><span class="p">(</span><span class="nc">DidCommMessage</span><span class="p">.</span><span class="nf">serializer</span><span class="p">(),</span> <span class="n">jsonString</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getKeyVersion</span><span class="p">():</span> <span class="nc">Int</span> <span class="p">=</span> <span class="n">keyVersion</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h4 id="step-2-update-storage-interface">
  
  
    <a href="#step-2-update-storage-interface" class="anchor-heading" aria-labelledby="step-2-update-storage-interface"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2: Update Storage Interface
  
  
</h4>
    
<p><strong>File</strong>: <code class="language-plaintext highlighter-rouge">credentials/plugins/didcomm/src/main/kotlin/com/trustweave/credential/didcomm/storage/DidCommMessageStorage.kt</code></p>

<p>Add optional encryption parameter:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kd">interface</span> <span class="nc">DidCommMessageStorage</span> <span class="p">{</span>
    <span class="c1">// ... existing methods ...</span>
    
    <span class="cm">/**
     * Sets message encryption (optional).
     * 
     * @param encryption Message encryption service
     */</span>
    <span class="k">fun</span> <span class="nf">setEncryption</span><span class="p">(</span><span class="n">encryption</span><span class="p">:</span> <span class="nc">MessageEncryption</span><span class="p">?)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h4 id="step-3-update-postgresql-storage">
  
  
    <a href="#step-3-update-postgresql-storage" class="anchor-heading" aria-labelledby="step-3-update-postgresql-storage"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3: Update PostgreSQL Storage
  
  
</h4>
    
<p><strong>File</strong>: <code class="language-plaintext highlighter-rouge">credentials/plugins/didcomm/src/main/kotlin/com/trustweave/credential/didcomm/storage/database/PostgresDidCommMessageStorage.kt</code></p>

<p>Add encryption support:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">PostgresDidCommMessageStorage</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">dataSource</span><span class="p">:</span> <span class="nc">DataSource</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">encryption</span><span class="p">:</span> <span class="nc">MessageEncryption</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">DidCommMessageStorage</span> <span class="p">{</span>
    
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">setEncryption</span><span class="p">(</span><span class="n">encryption</span><span class="p">:</span> <span class="nc">MessageEncryption</span><span class="p">?)</span> <span class="p">{</span>
        <span class="c1">// Update encryption instance</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">store</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nc">DidCommMessage</span><span class="p">):</span> <span class="nc">String</span> <span class="p">=</span> <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">messageToStore</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">encryption</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Encrypt message</span>
            <span class="kd">val</span> <span class="py">encrypted</span> <span class="p">=</span> <span class="n">encryption</span><span class="p">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="c1">// Store encrypted data</span>
            <span class="nf">storeEncrypted</span><span class="p">(</span><span class="n">encrypted</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">message</span><span class="p">.</span><span class="n">id</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Store unencrypted (existing logic)</span>
            <span class="nf">storeUnencrypted</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">message</span><span class="p">.</span><span class="n">id</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">storeEncrypted</span><span class="p">(</span>
        <span class="n">encrypted</span><span class="p">:</span> <span class="nc">EncryptedMessage</span><span class="p">,</span>
        <span class="n">messageId</span><span class="p">:</span> <span class="nc">String</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Store encrypted data in database</span>
        <span class="c1">// Add columns: encrypted_data BYTEA, key_version INT, iv BYTEA</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h3 id="database-schema-updates">
  
  
    <a href="#database-schema-updates" class="anchor-heading" aria-labelledby="database-schema-updates"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Database Schema Updates
  
  
</h3>
    

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c1">-- Add encryption columns to messages table</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">didcomm_messages</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">encrypted_data</span> <span class="n">BYTEA</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">didcomm_messages</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">key_version</span> <span class="nb">INT</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">didcomm_messages</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">iv</span> <span class="n">BYTEA</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">didcomm_messages</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">is_encrypted</span> <span class="nb">BOOLEAN</span> <span class="k">DEFAULT</span> <span class="k">FALSE</span><span class="p">;</span>

<span class="c1">-- Create index for key version (for key rotation queries)</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">idx_messages_key_version</span> <span class="k">ON</span> <span class="n">didcomm_messages</span><span class="p">(</span><span class="n">key_version</span><span class="p">);</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h3 id="key-management">
  
  
    <a href="#key-management" class="anchor-heading" aria-labelledby="key-management"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Key Management
  
  
</h3>
    

<p><strong>File</strong>: <code class="language-plaintext highlighter-rouge">credentials/plugins/didcomm/src/main/kotlin/com/trustweave/credential/didcomm/storage/encryption/EncryptionKeyManager.kt</code></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * Manages encryption keys with rotation support.
 */</span>
<span class="kd">interface</span> <span class="nc">EncryptionKeyManager</span> <span class="p">{</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getCurrentKey</span><span class="p">():</span> <span class="nc">ByteArray</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getKey</span><span class="p">(</span><span class="n">version</span><span class="p">:</span> <span class="nc">Int</span><span class="p">):</span> <span class="nc">ByteArray</span><span class="p">?</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">rotateKey</span><span class="p">():</span> <span class="nc">Int</span> <span class="c1">// Returns new key version</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getKeyVersions</span><span class="p">():</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div><hr />
<h2 id="3-mongodb-storage-implementation">
  
  
    <a href="#3-mongodb-storage-implementation" class="anchor-heading" aria-labelledby="3-mongodb-storage-implementation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. MongoDB Storage Implementation
  
  
</h2>
    
<h3 id="overview-3">
  
  
    <a href="#overview-3" class="anchor-heading" aria-labelledby="overview-3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview
  
  
</h3>
    
<p>Implement MongoDB backend for message storage, providing NoSQL alternative to PostgreSQL.</p>
<h3 id="architecture-2">
  
  
    <a href="#architecture-2" class="anchor-heading" aria-labelledby="architecture-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Architecture
  
  
</h3>
    

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>MongoDidCommMessageStorage
    │
    ├── MongoDB Connection
    │   └── Connection Pooling
    │
    ├── Document Structure
    │   └── Optimized for MongoDB queries
    │
    └── Indexes
        ├── DID indexes
        ├── Thread indexes
        └── Time-based indexes
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h3 id="implementation-steps-2">
  
  
    <a href="#implementation-steps-2" class="anchor-heading" aria-labelledby="implementation-steps-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Implementation Steps
  
  
</h3>
    
<h4 id="step-1-add-mongodb-dependencies">
  
  
    <a href="#step-1-add-mongodb-dependencies" class="anchor-heading" aria-labelledby="step-1-add-mongodb-dependencies"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1: Add MongoDB Dependencies
  
  
</h4>
    
<p><strong>File</strong>: <code class="language-plaintext highlighter-rouge">credentials/plugins/didcomm/build.gradle.kts</code></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c1">// MongoDB driver</span>
<span class="nf">implementation</span><span class="p">(</span><span class="s">"org.mongodb:mongodb-driver-kotlin-coroutine:4.11.0"</span><span class="p">)</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h4 id="step-2-create-mongodb-storage">
  
  
    <a href="#step-2-create-mongodb-storage" class="anchor-heading" aria-labelledby="step-2-create-mongodb-storage"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2: Create MongoDB Storage
  
  
</h4>
    
<p><strong>File</strong>: <code class="language-plaintext highlighter-rouge">credentials/plugins/didcomm/src/main/kotlin/com/trustweave/credential/didcomm/storage/database/MongoDidCommMessageStorage.kt</code></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="nn">com.trustweave.credential.didcomm.storage.database</span>

<span class="k">import</span> <span class="nn">com.mongodb.client.model.Filters</span>
<span class="k">import</span> <span class="nn">com.mongodb.client.model.Indexes</span>
<span class="k">import</span> <span class="nn">com.mongodb.client.model.Sorts</span>
<span class="k">import</span> <span class="nn">com.mongodb.kotlin.client.coroutine.MongoClient</span>
<span class="k">import</span> <span class="nn">com.mongodb.kotlin.client.coroutine.MongoCollection</span>
<span class="k">import</span> <span class="nn">com.mongodb.kotlin.client.coroutine.MongoDatabase</span>
<span class="k">import</span> <span class="nn">com.trustweave.credential.didcomm.models.DidCommMessage</span>
<span class="k">import</span> <span class="nn">com.trustweave.credential.didcomm.storage.*</span>
<span class="k">import</span> <span class="nn">kotlinx.coroutines.Dispatchers</span>
<span class="k">import</span> <span class="nn">kotlinx.coroutines.withContext</span>
<span class="k">import</span> <span class="nn">kotlinx.serialization.json.*</span>
<span class="k">import</span> <span class="nn">org.bson.Document</span>

<span class="cm">/**
 * MongoDB-backed message storage.
 * 
 * Uses MongoDB for flexible document storage with efficient queries.
 */</span>
<span class="kd">class</span> <span class="nc">MongoDidCommMessageStorage</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">mongoClient</span><span class="p">:</span> <span class="nc">MongoClient</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">databaseName</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">"trustweave"</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">collectionName</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">"didcomm_messages"</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">DidCommMessageStorage</span> <span class="p">{</span>
    
    <span class="k">private</span> <span class="kd">val</span> <span class="py">database</span><span class="p">:</span> <span class="nc">MongoDatabase</span> <span class="p">=</span> <span class="n">mongoClient</span><span class="p">.</span><span class="nf">getDatabase</span><span class="p">(</span><span class="n">databaseName</span><span class="p">)</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">collection</span><span class="p">:</span> <span class="nc">MongoCollection</span><span class="p">&lt;</span><span class="nc">Document</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">database</span><span class="p">.</span><span class="nf">getCollection</span><span class="p">(</span><span class="n">collectionName</span><span class="p">)</span>
    
    <span class="nf">init</span> <span class="p">{</span>
        <span class="nf">createIndexes</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">store</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nc">DidCommMessage</span><span class="p">):</span> <span class="nc">String</span> <span class="p">=</span> <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">json</span> <span class="p">=</span> <span class="nc">Json</span> <span class="p">{</span> <span class="n">prettyPrint</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span> <span class="n">encodeDefaults</span> <span class="p">=</span> <span class="k">false</span> <span class="p">}</span>
        <span class="kd">val</span> <span class="py">messageJson</span> <span class="p">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">encodeToString</span><span class="p">(</span>
            <span class="nc">DidCommMessage</span><span class="p">.</span><span class="nf">serializer</span><span class="p">(),</span>
            <span class="n">message</span>
        <span class="p">)</span>
        
        <span class="kd">val</span> <span class="py">document</span> <span class="p">=</span> <span class="nc">Document</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">messageJson</span><span class="p">).</span><span class="nf">apply</span> <span class="p">{</span>
            <span class="nf">put</span><span class="p">(</span><span class="s">"_id"</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
            <span class="nf">put</span><span class="p">(</span><span class="s">"from_did"</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">from</span><span class="p">)</span>
            <span class="nf">put</span><span class="p">(</span><span class="s">"to_dids"</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">to</span><span class="p">)</span>
            <span class="nf">put</span><span class="p">(</span><span class="s">"type"</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">type</span><span class="p">)</span>
            <span class="nf">put</span><span class="p">(</span><span class="s">"thid"</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">thid</span><span class="p">)</span>
            <span class="nf">put</span><span class="p">(</span><span class="s">"created_time"</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">created</span><span class="p">)</span>
            <span class="nf">put</span><span class="p">(</span><span class="s">"expires_time"</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">expiresTime</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="n">collection</span><span class="p">.</span><span class="nf">insertOne</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
        <span class="n">message</span><span class="p">.</span><span class="n">id</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">get</span><span class="p">(</span><span class="n">messageId</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">DidCommMessage</span><span class="p">?</span> <span class="p">=</span> <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">document</span> <span class="p">=</span> <span class="n">collection</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="nc">Filters</span><span class="p">.</span><span class="nf">eq</span><span class="p">(</span><span class="s">"_id"</span><span class="p">,</span> <span class="n">messageId</span><span class="p">)).</span><span class="nf">first</span><span class="p">()</span>
            <span class="o">?:</span> <span class="k">return</span><span class="nd">@withContext</span> <span class="k">null</span>
        
        <span class="kd">val</span> <span class="py">json</span> <span class="p">=</span> <span class="nc">Json</span> <span class="p">{</span> <span class="n">ignoreUnknownKeys</span> <span class="p">=</span> <span class="k">true</span> <span class="p">}</span>
        <span class="n">json</span><span class="p">.</span><span class="nf">decodeFromString</span><span class="p">(</span>
            <span class="nc">DidCommMessage</span><span class="p">.</span><span class="nf">serializer</span><span class="p">(),</span>
            <span class="n">document</span><span class="p">.</span><span class="nf">toJson</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getMessagesForDid</span><span class="p">(</span>
        <span class="n">did</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
        <span class="n">offset</span><span class="p">:</span> <span class="nc">Int</span>
    <span class="p">):</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">DidCommMessage</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">filter</span> <span class="p">=</span> <span class="nc">Filters</span><span class="p">.</span><span class="nf">or</span><span class="p">(</span>
            <span class="nc">Filters</span><span class="p">.</span><span class="nf">eq</span><span class="p">(</span><span class="s">"from_did"</span><span class="p">,</span> <span class="n">did</span><span class="p">),</span>
            <span class="nc">Filters</span><span class="p">.</span><span class="k">in</span><span class="p">(</span><span class="s">"to_dids"</span><span class="p">,</span> <span class="n">did</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="n">collection</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">filter</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="nc">Sorts</span><span class="p">.</span><span class="nf">descending</span><span class="p">(</span><span class="s">"created_time"</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">skip</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">toList</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="n">document</span> <span class="p">-&gt;</span>
                <span class="kd">val</span> <span class="py">json</span> <span class="p">=</span> <span class="nc">Json</span> <span class="p">{</span> <span class="n">ignoreUnknownKeys</span> <span class="p">=</span> <span class="k">true</span> <span class="p">}</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">decodeFromString</span><span class="p">(</span>
                    <span class="nc">DidCommMessage</span><span class="p">.</span><span class="nf">serializer</span><span class="p">(),</span>
                    <span class="n">document</span><span class="p">.</span><span class="nf">toJson</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getThreadMessages</span><span class="p">(</span><span class="n">thid</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">DidCommMessage</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">collection</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="nc">Filters</span><span class="p">.</span><span class="nf">eq</span><span class="p">(</span><span class="s">"thid"</span><span class="p">,</span> <span class="n">thid</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="nc">Sorts</span><span class="p">.</span><span class="nf">ascending</span><span class="p">(</span><span class="s">"created_time"</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">toList</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="n">document</span> <span class="p">-&gt;</span>
                <span class="kd">val</span> <span class="py">json</span> <span class="p">=</span> <span class="nc">Json</span> <span class="p">{</span> <span class="n">ignoreUnknownKeys</span> <span class="p">=</span> <span class="k">true</span> <span class="p">}</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">decodeFromString</span><span class="p">(</span>
                    <span class="nc">DidCommMessage</span><span class="p">.</span><span class="nf">serializer</span><span class="p">(),</span>
                    <span class="n">document</span><span class="p">.</span><span class="nf">toJson</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">delete</span><span class="p">(</span><span class="n">messageId</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">Boolean</span> <span class="p">=</span> <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">collection</span><span class="p">.</span><span class="nf">deleteOne</span><span class="p">(</span><span class="nc">Filters</span><span class="p">.</span><span class="nf">eq</span><span class="p">(</span><span class="s">"_id"</span><span class="p">,</span> <span class="n">messageId</span><span class="p">))</span>
        <span class="n">result</span><span class="p">.</span><span class="n">deletedCount</span> <span class="p">&gt;</span> <span class="mi">0</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">deleteMessagesForDid</span><span class="p">(</span><span class="n">did</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">Int</span> <span class="p">=</span> <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">filter</span> <span class="p">=</span> <span class="nc">Filters</span><span class="p">.</span><span class="nf">or</span><span class="p">(</span>
            <span class="nc">Filters</span><span class="p">.</span><span class="nf">eq</span><span class="p">(</span><span class="s">"from_did"</span><span class="p">,</span> <span class="n">did</span><span class="p">),</span>
            <span class="nc">Filters</span><span class="p">.</span><span class="k">in</span><span class="p">(</span><span class="s">"to_dids"</span><span class="p">,</span> <span class="n">did</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">collection</span><span class="p">.</span><span class="nf">deleteMany</span><span class="p">(</span><span class="n">filter</span><span class="p">)</span>
        <span class="n">result</span><span class="p">.</span><span class="n">deletedCount</span><span class="p">.</span><span class="nf">toInt</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">deleteThreadMessages</span><span class="p">(</span><span class="n">thid</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">Int</span> <span class="p">=</span> <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">collection</span><span class="p">.</span><span class="nf">deleteMany</span><span class="p">(</span><span class="nc">Filters</span><span class="p">.</span><span class="nf">eq</span><span class="p">(</span><span class="s">"thid"</span><span class="p">,</span> <span class="n">thid</span><span class="p">))</span>
        <span class="n">result</span><span class="p">.</span><span class="n">deletedCount</span><span class="p">.</span><span class="nf">toInt</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">countMessagesForDid</span><span class="p">(</span><span class="n">did</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">Int</span> <span class="p">=</span> <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">filter</span> <span class="p">=</span> <span class="nc">Filters</span><span class="p">.</span><span class="nf">or</span><span class="p">(</span>
            <span class="nc">Filters</span><span class="p">.</span><span class="nf">eq</span><span class="p">(</span><span class="s">"from_did"</span><span class="p">,</span> <span class="n">did</span><span class="p">),</span>
            <span class="nc">Filters</span><span class="p">.</span><span class="k">in</span><span class="p">(</span><span class="s">"to_dids"</span><span class="p">,</span> <span class="n">did</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">collection</span><span class="p">.</span><span class="nf">countDocuments</span><span class="p">(</span><span class="n">filter</span><span class="p">).</span><span class="nf">toInt</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">search</span><span class="p">(</span>
        <span class="n">filter</span><span class="p">:</span> <span class="nc">MessageFilter</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
        <span class="n">offset</span><span class="p">:</span> <span class="nc">Int</span>
    <span class="p">):</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">DidCommMessage</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">mongoFilter</span> <span class="p">=</span> <span class="nf">buildMongoFilter</span><span class="p">(</span><span class="n">filter</span><span class="p">)</span>
        
        <span class="n">collection</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">mongoFilter</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="nc">Sorts</span><span class="p">.</span><span class="nf">descending</span><span class="p">(</span><span class="s">"created_time"</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">skip</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">toList</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="n">document</span> <span class="p">-&gt;</span>
                <span class="kd">val</span> <span class="py">json</span> <span class="p">=</span> <span class="nc">Json</span> <span class="p">{</span> <span class="n">ignoreUnknownKeys</span> <span class="p">=</span> <span class="k">true</span> <span class="p">}</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">decodeFromString</span><span class="p">(</span>
                    <span class="nc">DidCommMessage</span><span class="p">.</span><span class="nf">serializer</span><span class="p">(),</span>
                    <span class="n">document</span><span class="p">.</span><span class="nf">toJson</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">buildMongoFilter</span><span class="p">(</span><span class="n">filter</span><span class="p">:</span> <span class="nc">MessageFilter</span><span class="p">):</span> <span class="nc">Document</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">conditions</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="nc">Document</span><span class="p">&gt;()</span>
        
        <span class="n">filter</span><span class="p">.</span><span class="n">fromDid</span><span class="o">?.</span><span class="nf">let</span> <span class="p">{</span>
            <span class="n">conditions</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Document</span><span class="p">(</span><span class="s">"from_did"</span><span class="p">,</span> <span class="n">it</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="n">filter</span><span class="p">.</span><span class="n">toDid</span><span class="o">?.</span><span class="nf">let</span> <span class="p">{</span>
            <span class="n">conditions</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Document</span><span class="p">(</span><span class="s">"to_dids"</span><span class="p">,</span> <span class="n">it</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="n">filter</span><span class="p">.</span><span class="n">type</span><span class="o">?.</span><span class="nf">let</span> <span class="p">{</span>
            <span class="n">conditions</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Document</span><span class="p">(</span><span class="s">"type"</span><span class="p">,</span> <span class="n">it</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="n">filter</span><span class="p">.</span><span class="n">thid</span><span class="o">?.</span><span class="nf">let</span> <span class="p">{</span>
            <span class="n">conditions</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Document</span><span class="p">(</span><span class="s">"thid"</span><span class="p">,</span> <span class="n">it</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="n">filter</span><span class="p">.</span><span class="n">createdAfter</span><span class="o">?.</span><span class="nf">let</span> <span class="p">{</span>
            <span class="n">conditions</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Document</span><span class="p">(</span><span class="s">"created_time"</span><span class="p">,</span> <span class="nc">Document</span><span class="p">(</span><span class="s">"\$gte"</span><span class="p">,</span> <span class="n">it</span><span class="p">)))</span>
        <span class="p">}</span>
        <span class="n">filter</span><span class="p">.</span><span class="n">createdBefore</span><span class="o">?.</span><span class="nf">let</span> <span class="p">{</span>
            <span class="n">conditions</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Document</span><span class="p">(</span><span class="s">"created_time"</span><span class="p">,</span> <span class="nc">Document</span><span class="p">(</span><span class="s">"\$lte"</span><span class="p">,</span> <span class="n">it</span><span class="p">)))</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">conditions</span><span class="p">.</span><span class="nf">isEmpty</span><span class="p">())</span> <span class="p">{</span>
            <span class="nc">Document</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nc">Document</span><span class="p">(</span><span class="s">"\$and"</span><span class="p">,</span> <span class="n">conditions</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">createIndexes</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Create indexes for performance</span>
        <span class="n">collection</span><span class="p">.</span><span class="nf">createIndex</span><span class="p">(</span><span class="nc">Indexes</span><span class="p">.</span><span class="nf">ascending</span><span class="p">(</span><span class="s">"from_did"</span><span class="p">))</span>
        <span class="n">collection</span><span class="p">.</span><span class="nf">createIndex</span><span class="p">(</span><span class="nc">Indexes</span><span class="p">.</span><span class="nf">ascending</span><span class="p">(</span><span class="s">"to_dids"</span><span class="p">))</span>
        <span class="n">collection</span><span class="p">.</span><span class="nf">createIndex</span><span class="p">(</span><span class="nc">Indexes</span><span class="p">.</span><span class="nf">ascending</span><span class="p">(</span><span class="s">"thid"</span><span class="p">))</span>
        <span class="n">collection</span><span class="p">.</span><span class="nf">createIndex</span><span class="p">(</span><span class="nc">Indexes</span><span class="p">.</span><span class="nf">ascending</span><span class="p">(</span><span class="s">"created_time"</span><span class="p">))</span>
        <span class="n">collection</span><span class="p">.</span><span class="nf">createIndex</span><span class="p">(</span><span class="nc">Indexes</span><span class="p">.</span><span class="nf">ascending</span><span class="p">(</span><span class="s">"type"</span><span class="p">))</span>
        
        <span class="c1">// Compound indexes</span>
        <span class="n">collection</span><span class="p">.</span><span class="nf">createIndex</span><span class="p">(</span><span class="nc">Indexes</span><span class="p">.</span><span class="nf">compoundIndex</span><span class="p">(</span>
            <span class="nc">Indexes</span><span class="p">.</span><span class="nf">ascending</span><span class="p">(</span><span class="s">"from_did"</span><span class="p">),</span>
            <span class="nc">Indexes</span><span class="p">.</span><span class="nf">descending</span><span class="p">(</span><span class="s">"created_time"</span><span class="p">)</span>
        <span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div><hr />
<h2 id="4-message-archiving-to-cold-storage">
  
  
    <a href="#4-message-archiving-to-cold-storage" class="anchor-heading" aria-labelledby="4-message-archiving-to-cold-storage"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4. Message Archiving to Cold Storage
  
  
</h2>
    
<h3 id="overview-4">
  
  
    <a href="#overview-4" class="anchor-heading" aria-labelledby="overview-4"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview
  
  
</h3>
    
<p>Archive old messages to cold storage (S3, Azure Blob, etc.) to reduce database size and costs.</p>
<h3 id="architecture-3">
  
  
    <a href="#architecture-3" class="anchor-heading" aria-labelledby="architecture-3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Architecture
  
  
</h3>
    

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>Message Archiver
    │
    ├── Archive Policy
    │   ├── Age-based (e.g., &gt;90 days)
    │   ├── Size-based (e.g., &gt;1GB)
    │   └── Custom rules
    │
    ├── Archive Format
    │   ├── Compressed (gzip)
    │   └── Batch files (JSONL)
    │
    └── Storage Backends
        ├── AWS S3
        ├── Azure Blob
        └── Google Cloud Storage
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h3 id="implementation-steps-3">
  
  
    <a href="#implementation-steps-3" class="anchor-heading" aria-labelledby="implementation-steps-3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Implementation Steps
  
  
</h3>
    
<h4 id="step-1-create-archive-policy">
  
  
    <a href="#step-1-create-archive-policy" class="anchor-heading" aria-labelledby="step-1-create-archive-policy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1: Create Archive Policy
  
  
</h4>
    
<p><strong>File</strong>: <code class="language-plaintext highlighter-rouge">credentials/plugins/didcomm/src/main/kotlin/com/trustweave/credential/didcomm/storage/archive/ArchivePolicy.kt</code></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="nn">com.trustweave.credential.didcomm.storage.archive</span>

<span class="k">import</span> <span class="nn">com.trustweave.credential.didcomm.models.DidCommMessage</span>
<span class="k">import</span> <span class="nn">java.time.Instant</span>
<span class="k">import</span> <span class="nn">java.time.temporal.ChronoUnit</span>

<span class="cm">/**
 * Defines when messages should be archived.
 */</span>
<span class="kd">interface</span> <span class="nc">ArchivePolicy</span> <span class="p">{</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">shouldArchive</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nc">DidCommMessage</span><span class="p">):</span> <span class="nc">Boolean</span>
<span class="p">}</span>

<span class="cm">/**
 * Age-based archive policy.
 */</span>
<span class="kd">class</span> <span class="nc">AgeBasedArchivePolicy</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">maxAgeDays</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">90</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">ArchivePolicy</span> <span class="p">{</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">shouldArchive</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nc">DidCommMessage</span><span class="p">):</span> <span class="nc">Boolean</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">created</span> <span class="p">=</span> <span class="n">message</span><span class="p">.</span><span class="n">created</span><span class="o">?.</span><span class="nf">let</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="nc">Instant</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">Exception</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">null</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="o">?:</span> <span class="k">return</span> <span class="k">false</span>
        
        <span class="kd">val</span> <span class="py">age</span> <span class="p">=</span> <span class="nc">ChronoUnit</span><span class="p">.</span><span class="nc">DAYS</span><span class="p">.</span><span class="nf">between</span><span class="p">(</span><span class="n">created</span><span class="p">,</span> <span class="nc">Instant</span><span class="p">.</span><span class="nf">now</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">age</span> <span class="p">&gt;</span> <span class="n">maxAgeDays</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**
 * Composite archive policy.
 */</span>
<span class="kd">class</span> <span class="nc">CompositeArchivePolicy</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">policies</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">ArchivePolicy</span><span class="p">&gt;</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">ArchivePolicy</span> <span class="p">{</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">shouldArchive</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nc">DidCommMessage</span><span class="p">):</span> <span class="nc">Boolean</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">policies</span><span class="p">.</span><span class="nf">any</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="nf">shouldArchive</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h4 id="step-2-create-archive-service">
  
  
    <a href="#step-2-create-archive-service" class="anchor-heading" aria-labelledby="step-2-create-archive-service"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2: Create Archive Service
  
  
</h4>
    
<p><strong>File</strong>: <code class="language-plaintext highlighter-rouge">credentials/plugins/didcomm/src/main/kotlin/com/trustweave/credential/didcomm/storage/archive/MessageArchiver.kt</code></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="nn">com.trustweave.credential.didcomm.storage.archive</span>

<span class="k">import</span> <span class="nn">com.trustweave.credential.didcomm.models.DidCommMessage</span>
<span class="k">import</span> <span class="nn">com.trustweave.credential.didcomm.storage.DidCommMessageStorage</span>
<span class="k">import</span> <span class="nn">kotlinx.coroutines.Dispatchers</span>
<span class="k">import</span> <span class="nn">kotlinx.coroutines.withContext</span>
<span class="k">import</span> <span class="nn">kotlinx.serialization.json.*</span>
<span class="k">import</span> <span class="nn">java.io.ByteArrayOutputStream</span>
<span class="k">import</span> <span class="nn">java.util.zip.GZIPOutputStream</span>

<span class="cm">/**
 * Archives messages to cold storage.
 */</span>
<span class="kd">interface</span> <span class="nc">MessageArchiver</span> <span class="p">{</span>
    <span class="cm">/**
     * Archives messages matching the policy.
     */</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">archiveMessages</span><span class="p">(</span><span class="n">policy</span><span class="p">:</span> <span class="nc">ArchivePolicy</span><span class="p">):</span> <span class="nc">ArchiveResult</span>
    
    <span class="cm">/**
     * Restores archived messages.
     */</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">restoreMessages</span><span class="p">(</span><span class="n">archiveId</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">RestoreResult</span>
<span class="p">}</span>

<span class="kd">data class</span> <span class="nc">ArchiveResult</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">archiveId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">messageCount</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">archiveSize</span><span class="p">:</span> <span class="nc">Long</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">storageLocation</span><span class="p">:</span> <span class="nc">String</span>
<span class="p">)</span>

<span class="kd">data class</span> <span class="nc">RestoreResult</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">messageCount</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">restoredIds</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;</span>
<span class="p">)</span>

<span class="cm">/**
 * S3-based message archiver.
 */</span>
<span class="kd">class</span> <span class="nc">S3MessageArchiver</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">storage</span><span class="p">:</span> <span class="nc">DidCommMessageStorage</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">s3Client</span><span class="p">:</span> <span class="nc">Any</span><span class="p">,</span> <span class="c1">// AWS S3 client</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">bucketName</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">prefix</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">"archives/"</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">MessageArchiver</span> <span class="p">{</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">archiveMessages</span><span class="p">(</span><span class="n">policy</span><span class="p">:</span> <span class="nc">ArchivePolicy</span><span class="p">):</span> <span class="nc">ArchiveResult</span> <span class="p">=</span> <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Find messages to archive</span>
        <span class="kd">val</span> <span class="py">messagesToArchive</span> <span class="p">=</span> <span class="nf">findMessagesToArchive</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">messagesToArchive</span><span class="p">.</span><span class="nf">isEmpty</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span><span class="nd">@withContext</span> <span class="nc">ArchiveResult</span><span class="p">(</span>
                <span class="n">archiveId</span> <span class="p">=</span> <span class="s">""</span><span class="p">,</span>
                <span class="n">messageCount</span> <span class="p">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">archiveSize</span> <span class="p">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">storageLocation</span> <span class="p">=</span> <span class="s">""</span>
            <span class="p">)</span>
        <span class="p">}</span>
        
        <span class="c1">// Create archive file (compressed JSONL)</span>
        <span class="kd">val</span> <span class="py">archiveId</span> <span class="p">=</span> <span class="nf">generateArchiveId</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">archiveData</span> <span class="p">=</span> <span class="nf">createArchiveFile</span><span class="p">(</span><span class="n">messagesToArchive</span><span class="p">)</span>
        
        <span class="c1">// Upload to S3</span>
        <span class="kd">val</span> <span class="py">s3Key</span> <span class="p">=</span> <span class="s">"$prefix$archiveId.jsonl.gz"</span>
        <span class="nf">uploadToS3</span><span class="p">(</span><span class="n">s3Key</span><span class="p">,</span> <span class="n">archiveData</span><span class="p">)</span>
        
        <span class="c1">// Mark messages as archived in database</span>
        <span class="nf">markAsArchived</span><span class="p">(</span><span class="n">messagesToArchive</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">id</span> <span class="p">})</span>
        
        <span class="nc">ArchiveResult</span><span class="p">(</span>
            <span class="n">archiveId</span> <span class="p">=</span> <span class="n">archiveId</span><span class="p">,</span>
            <span class="n">messageCount</span> <span class="p">=</span> <span class="n">messagesToArchive</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
            <span class="n">archiveSize</span> <span class="p">=</span> <span class="n">archiveData</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="nf">toLong</span><span class="p">(),</span>
            <span class="n">storageLocation</span> <span class="p">=</span> <span class="s">"s3://$bucketName/$s3Key"</span>
        <span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">findMessagesToArchive</span><span class="p">(</span><span class="n">policy</span><span class="p">:</span> <span class="nc">ArchivePolicy</span><span class="p">):</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">DidCommMessage</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="c1">// Query all messages and filter by policy</span>
        <span class="c1">// In production, use efficient query based on policy</span>
        <span class="k">return</span> <span class="nf">emptyList</span><span class="p">()</span> <span class="c1">// Implementation</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">createArchiveFile</span><span class="p">(</span><span class="n">messages</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">DidCommMessage</span><span class="p">&gt;):</span> <span class="nc">ByteArray</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">json</span> <span class="p">=</span> <span class="nc">Json</span> <span class="p">{</span> <span class="n">prettyPrint</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span> <span class="n">encodeDefaults</span> <span class="p">=</span> <span class="k">false</span> <span class="p">}</span>
        <span class="kd">val</span> <span class="py">output</span> <span class="p">=</span> <span class="nc">ByteArrayOutputStream</span><span class="p">()</span>
        
        <span class="nc">GZIPOutputStream</span><span class="p">(</span><span class="n">output</span><span class="p">).</span><span class="nf">use</span> <span class="p">{</span> <span class="n">gzip</span> <span class="p">-&gt;</span>
            <span class="n">messages</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span> <span class="n">message</span> <span class="p">-&gt;</span>
                <span class="kd">val</span> <span class="py">line</span> <span class="p">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">encodeToString</span><span class="p">(</span>
                    <span class="nc">DidCommMessage</span><span class="p">.</span><span class="nf">serializer</span><span class="p">(),</span>
                    <span class="n">message</span>
                <span class="p">)</span> <span class="p">+</span> <span class="s">"\n"</span>
                <span class="n">gzip</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="nf">toByteArray</span><span class="p">(</span><span class="nc">Charsets</span><span class="p">.</span><span class="nc">UTF_8</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">output</span><span class="p">.</span><span class="nf">toByteArray</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">uploadToS3</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nc">ByteArray</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Upload to S3</span>
        <span class="c1">// Implementation depends on S3 client</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">markAsArchived</span><span class="p">(</span><span class="n">messageIds</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;)</span> <span class="p">{</span>
        <span class="c1">// Update database to mark messages as archived</span>
        <span class="c1">// Add 'archived' flag to messages table</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">generateArchiveId</span><span class="p">():</span> <span class="nc">String</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nc">UUID</span><span class="p">.</span><span class="nf">randomUUID</span><span class="p">().</span><span class="nf">toString</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h3 id="database-schema-updates-1">
  
  
    <a href="#database-schema-updates-1" class="anchor-heading" aria-labelledby="database-schema-updates-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Database Schema Updates
  
  
</h3>
    

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c1">-- Add archive tracking</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">didcomm_messages</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">archived</span> <span class="nb">BOOLEAN</span> <span class="k">DEFAULT</span> <span class="k">FALSE</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">didcomm_messages</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">archive_id</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">didcomm_messages</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">archived_at</span> <span class="nb">TIMESTAMP</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">idx_messages_archived</span> <span class="k">ON</span> <span class="n">didcomm_messages</span><span class="p">(</span><span class="n">archived</span><span class="p">);</span>
</pre></td></tr></tbody></table></div></code></pre></div></div><hr />
<h2 id="5-message-replication-for-high-availability">
  
  
    <a href="#5-message-replication-for-high-availability" class="anchor-heading" aria-labelledby="5-message-replication-for-high-availability"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5. Message Replication for High Availability
  
  
</h2>
    
<h3 id="overview-5">
  
  
    <a href="#overview-5" class="anchor-heading" aria-labelledby="overview-5"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview
  
  
</h3>
    
<p>Implement message replication across multiple database instances for high availability and disaster recovery.</p>
<h3 id="architecture-4">
  
  
    <a href="#architecture-4" class="anchor-heading" aria-labelledby="architecture-4"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Architecture
  
  
</h3>
    

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>Primary Database
    │
    ├── Replication Manager
    │   ├── Write to Primary
    │   ├── Async Replication
    │   └── Conflict Resolution
    │
    └── Replica Databases
        ├── Replica 1
        ├── Replica 2
        └── Replica N
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h3 id="implementation-steps-4">
  
  
    <a href="#implementation-steps-4" class="anchor-heading" aria-labelledby="implementation-steps-4"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Implementation Steps
  
  
</h3>
    
<h4 id="step-1-create-replication-manager">
  
  
    <a href="#step-1-create-replication-manager" class="anchor-heading" aria-labelledby="step-1-create-replication-manager"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1: Create Replication Manager
  
  
</h4>
    
<p><strong>File</strong>: <code class="language-plaintext highlighter-rouge">credentials/plugins/didcomm/src/main/kotlin/com/trustweave/credential/didcomm/storage/replication/ReplicationManager.kt</code></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="nn">com.trustweave.credential.didcomm.storage.replication</span>

<span class="k">import</span> <span class="nn">com.trustweave.credential.didcomm.models.DidCommMessage</span>
<span class="k">import</span> <span class="nn">com.trustweave.credential.didcomm.storage.DidCommMessageStorage</span>
<span class="k">import</span> <span class="nn">kotlinx.coroutines.async</span>
<span class="k">import</span> <span class="nn">kotlinx.coroutines.awaitAll</span>
<span class="k">import</span> <span class="nn">kotlinx.coroutines.coroutineScope</span>

<span class="cm">/**
 * Manages message replication across multiple storage backends.
 */</span>
<span class="kd">class</span> <span class="nc">ReplicationManager</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">primary</span><span class="p">:</span> <span class="nc">DidCommMessageStorage</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">replicas</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">DidCommMessageStorage</span><span class="p">&gt;,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">replicationMode</span><span class="p">:</span> <span class="nc">ReplicationMode</span> <span class="p">=</span> <span class="nc">ReplicationMode</span><span class="p">.</span><span class="nc">ASYNC</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">DidCommMessageStorage</span> <span class="p">{</span>
    
    <span class="k">enum</span> <span class="kd">class</span> <span class="nc">ReplicationMode</span> <span class="p">{</span>
        <span class="nc">SYNC</span><span class="p">,</span>  <span class="c1">// Wait for all replicas</span>
        <span class="nc">ASYNC</span><span class="p">,</span> <span class="c1">// Fire and forget</span>
        <span class="nc">QUORUM</span> <span class="c1">// Wait for majority</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">store</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nc">DidCommMessage</span><span class="p">):</span> <span class="nc">String</span> <span class="p">=</span> <span class="nf">coroutineScope</span> <span class="p">{</span>
        <span class="c1">// Write to primary</span>
        <span class="kd">val</span> <span class="py">messageId</span> <span class="p">=</span> <span class="n">primary</span><span class="p">.</span><span class="nf">store</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        
        <span class="c1">// Replicate to replicas</span>
        <span class="k">when</span> <span class="p">(</span><span class="n">replicationMode</span><span class="p">)</span> <span class="p">{</span>
            <span class="nc">ReplicationMode</span><span class="p">.</span><span class="nc">SYNC</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="n">replicas</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="nf">async</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="nf">store</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="p">}</span> <span class="p">}.</span><span class="nf">awaitAll</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="nc">ReplicationMode</span><span class="p">.</span><span class="nc">ASYNC</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="n">replicas</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span> <span class="n">replica</span> <span class="p">-&gt;</span>
                    <span class="c1">// Fire and forget</span>
                    <span class="n">kotlinx</span><span class="p">.</span><span class="n">coroutines</span><span class="p">.</span><span class="nf">launch</span> <span class="p">{</span>
                        <span class="k">try</span> <span class="p">{</span>
                            <span class="n">replica</span><span class="p">.</span><span class="nf">store</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">Exception</span><span class="p">)</span> <span class="p">{</span>
                            <span class="c1">// Log error, continue</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="nc">ReplicationMode</span><span class="p">.</span><span class="nc">QUORUM</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="kd">val</span> <span class="py">quorum</span> <span class="p">=</span> <span class="p">(</span><span class="n">replicas</span><span class="p">.</span><span class="n">size</span> <span class="p">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">+</span> <span class="mi">1</span>
                <span class="n">replicas</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="nf">async</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="nf">store</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
                    <span class="p">.</span><span class="nf">take</span><span class="p">(</span><span class="n">quorum</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">awaitAll</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="n">messageId</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">get</span><span class="p">(</span><span class="n">messageId</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">DidCommMessage</span><span class="p">?</span> <span class="p">{</span>
        <span class="c1">// Try primary first</span>
        <span class="k">return</span> <span class="n">primary</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">messageId</span><span class="p">)</span> <span class="o">?:</span> <span class="nf">run</span> <span class="p">{</span>
            <span class="c1">// If not found, try replicas</span>
            <span class="n">replicas</span><span class="p">.</span><span class="nf">firstNotNullOfOrNull</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">messageId</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// Implement other methods with replication logic...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h4 id="step-2-health-checks">
  
  
    <a href="#step-2-health-checks" class="anchor-heading" aria-labelledby="step-2-health-checks"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2: Health Checks
  
  
</h4>
    
<p><strong>File</strong>: <code class="language-plaintext highlighter-rouge">credentials/plugins/didcomm/src/main/kotlin/com/trustweave/credential/didcomm/storage/replication/ReplicaHealthCheck.kt</code></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * Health check for replica databases.
 */</span>
<span class="kd">interface</span> <span class="nc">ReplicaHealthCheck</span> <span class="p">{</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">checkHealth</span><span class="p">(</span><span class="n">storage</span><span class="p">:</span> <span class="nc">DidCommMessageStorage</span><span class="p">):</span> <span class="nc">HealthStatus</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getHealthyReplicas</span><span class="p">():</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">DidCommMessageStorage</span><span class="p">&gt;</span>
<span class="p">}</span>

<span class="kd">data class</span> <span class="nc">HealthStatus</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">isHealthy</span><span class="p">:</span> <span class="nc">Boolean</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">latency</span><span class="p">:</span> <span class="nc">Long</span><span class="p">,</span> <span class="c1">// milliseconds</span>
    <span class="kd">val</span> <span class="py">lastCheck</span><span class="p">:</span> <span class="nc">Instant</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></div></code></pre></div></div><hr />
<h2 id="6-advanced-search-capabilities">
  
  
    <a href="#6-advanced-search-capabilities" class="anchor-heading" aria-labelledby="6-advanced-search-capabilities"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 6. Advanced Search Capabilities
  
  
</h2>
    
<h3 id="overview-6">
  
  
    <a href="#overview-6" class="anchor-heading" aria-labelledby="overview-6"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview
  
  
</h3>
    
<p>Implement full-text search, faceted search, and complex query capabilities.</p>
<h3 id="architecture-5">
  
  
    <a href="#architecture-5" class="anchor-heading" aria-labelledby="architecture-5"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Architecture
  
  
</h3>
    

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>Advanced Search
    │
    ├── Full-Text Search
    │   └── Elasticsearch/PostgreSQL FTS
    │
    ├── Faceted Search
    │   └── Aggregations
    │
    └── Complex Queries
        ├── Boolean operators
        ├── Range queries
        └── Regex queries
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h3 id="implementation-steps-5">
  
  
    <a href="#implementation-steps-5" class="anchor-heading" aria-labelledby="implementation-steps-5"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Implementation Steps
  
  
</h3>
    
<h4 id="step-1-create-search-interface">
  
  
    <a href="#step-1-create-search-interface" class="anchor-heading" aria-labelledby="step-1-create-search-interface"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1: Create Search Interface
  
  
</h4>
    
<p><strong>File</strong>: <code class="language-plaintext highlighter-rouge">credentials/plugins/didcomm/src/main/kotlin/com/trustweave/credential/didcomm/storage/search/AdvancedSearch.kt</code></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="nn">com.trustweave.credential.didcomm.storage.search</span>

<span class="k">import</span> <span class="nn">com.trustweave.credential.didcomm.models.DidCommMessage</span>

<span class="cm">/**
 * Advanced search interface.
 */</span>
<span class="kd">interface</span> <span class="nc">AdvancedSearch</span> <span class="p">{</span>
    <span class="cm">/**
     * Full-text search across message content.
     */</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">fullTextSearch</span><span class="p">(</span>
        <span class="n">query</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">offset</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="p">):</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">DidCommMessage</span><span class="p">&gt;</span>
    
    <span class="cm">/**
     * Faceted search with aggregations.
     */</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">facetedSearch</span><span class="p">(</span>
        <span class="n">query</span><span class="p">:</span> <span class="nc">SearchQuery</span><span class="p">,</span>
        <span class="n">facets</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Facet</span><span class="p">&gt;</span>
    <span class="p">):</span> <span class="nc">FacetedSearchResult</span>
    
    <span class="cm">/**
     * Complex query with boolean operators.
     */</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">complexQuery</span><span class="p">(</span>
        <span class="n">query</span><span class="p">:</span> <span class="nc">ComplexQuery</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">offset</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="p">):</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">DidCommMessage</span><span class="p">&gt;</span>
<span class="p">}</span>

<span class="kd">data class</span> <span class="nc">SearchQuery</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">text</span><span class="p">:</span> <span class="nc">String</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">filters</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">Any</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nf">emptyMap</span><span class="p">(),</span>
    <span class="kd">val</span> <span class="py">sort</span><span class="p">:</span> <span class="nc">SortOrder</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
<span class="p">)</span>

<span class="kd">data class</span> <span class="nc">Facet</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">field</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">type</span><span class="p">:</span> <span class="nc">FacetType</span>
<span class="p">)</span>

<span class="k">enum</span> <span class="kd">class</span> <span class="nc">FacetType</span> <span class="p">{</span>
    <span class="nc">TERMS</span><span class="p">,</span>  <span class="c1">// Count distinct values</span>
    <span class="nc">RANGE</span><span class="p">,</span>  <span class="c1">// Range aggregations</span>
    <span class="nc">DATE</span>    <span class="c1">// Date range aggregations</span>
<span class="p">}</span>

<span class="kd">data class</span> <span class="nc">FacetedSearchResult</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">results</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">DidCommMessage</span><span class="p">&gt;,</span>
    <span class="kd">val</span> <span class="py">facets</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">FacetResult</span><span class="p">&gt;</span>
<span class="p">)</span>

<span class="kd">data class</span> <span class="nc">ComplexQuery</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">conditions</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">QueryCondition</span><span class="p">&gt;,</span>
    <span class="kd">val</span> <span class="py">operator</span><span class="p">:</span> <span class="nc">BooleanOperator</span> <span class="p">=</span> <span class="nc">BooleanOperator</span><span class="p">.</span><span class="nc">AND</span>
<span class="p">)</span>

<span class="k">enum</span> <span class="kd">class</span> <span class="nc">BooleanOperator</span> <span class="p">{</span>
    <span class="nc">AND</span><span class="p">,</span> <span class="nc">OR</span><span class="p">,</span> <span class="nc">NOT</span>
<span class="p">}</span>

<span class="kd">data class</span> <span class="nc">QueryCondition</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">field</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">operator</span><span class="p">:</span> <span class="nc">ComparisonOperator</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">value</span><span class="p">:</span> <span class="nc">Any</span>
<span class="p">)</span>

<span class="k">enum</span> <span class="kd">class</span> <span class="nc">ComparisonOperator</span> <span class="p">{</span>
    <span class="nc">EQ</span><span class="p">,</span> <span class="nc">NE</span><span class="p">,</span> <span class="nc">GT</span><span class="p">,</span> <span class="nc">GTE</span><span class="p">,</span> <span class="nc">LT</span><span class="p">,</span> <span class="nc">LTE</span><span class="p">,</span> <span class="nc">LIKE</span><span class="p">,</span> <span class="nc">IN</span><span class="p">,</span> <span class="nc">BETWEEN</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h4 id="step-2-postgresql-full-text-search">
  
  
    <a href="#step-2-postgresql-full-text-search" class="anchor-heading" aria-labelledby="step-2-postgresql-full-text-search"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2: PostgreSQL Full-Text Search
  
  
</h4>
    
<p><strong>File</strong>: <code class="language-plaintext highlighter-rouge">credentials/plugins/didcomm/src/main/kotlin/com/trustweave/credential/didcomm/storage/search/PostgresFullTextSearch.kt</code></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * PostgreSQL full-text search implementation.
 */</span>
<span class="kd">class</span> <span class="nc">PostgresFullTextSearch</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">storage</span><span class="p">:</span> <span class="nc">PostgresDidCommMessageStorage</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">AdvancedSearch</span> <span class="p">{</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">fullTextSearch</span><span class="p">(</span>
        <span class="n">query</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
        <span class="n">offset</span><span class="p">:</span> <span class="nc">Int</span>
    <span class="p">):</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">DidCommMessage</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="c1">// Use PostgreSQL tsvector/tsquery for full-text search</span>
        <span class="c1">// Add GIN index on searchable fields</span>
        <span class="k">return</span> <span class="nf">emptyList</span><span class="p">()</span> <span class="c1">// Implementation</span>
    <span class="p">}</span>
    
    <span class="c1">// Implement other methods...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h3 id="database-schema-updates-2">
  
  
    <a href="#database-schema-updates-2" class="anchor-heading" aria-labelledby="database-schema-updates-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Database Schema Updates
  
  
</h3>
    

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="c1">-- Add full-text search column</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">didcomm_messages</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">search_vector</span> <span class="n">tsvector</span><span class="p">;</span>

<span class="c1">-- Create GIN index for full-text search</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">idx_messages_search_vector</span> 
<span class="k">ON</span> <span class="n">didcomm_messages</span> <span class="k">USING</span> <span class="n">GIN</span><span class="p">(</span><span class="n">search_vector</span><span class="p">);</span>

<span class="c1">-- Create trigger to update search vector</span>
<span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="n">update_message_search_vector</span><span class="p">()</span>
<span class="k">RETURNS</span> <span class="k">TRIGGER</span> <span class="k">AS</span> <span class="err">$$</span>
<span class="k">BEGIN</span>
    <span class="k">NEW</span><span class="p">.</span><span class="n">search_vector</span> <span class="p">:</span><span class="o">=</span>
        <span class="n">to_tsvector</span><span class="p">(</span><span class="s1">'english'</span><span class="p">,</span> <span class="n">COALESCE</span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="k">type</span><span class="p">,</span> <span class="s1">''</span><span class="p">))</span> <span class="o">||</span>
        <span class="n">to_tsvector</span><span class="p">(</span><span class="s1">'english'</span><span class="p">,</span> <span class="n">COALESCE</span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="n">body</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span> <span class="s1">''</span><span class="p">));</span>
    <span class="k">RETURN</span> <span class="k">NEW</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$$</span> <span class="k">LANGUAGE</span> <span class="n">plpgsql</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">message_search_vector_update</span>
<span class="k">BEFORE</span> <span class="k">INSERT</span> <span class="k">OR</span> <span class="k">UPDATE</span> <span class="k">ON</span> <span class="n">didcomm_messages</span>
<span class="k">FOR</span> <span class="k">EACH</span> <span class="k">ROW</span> <span class="k">EXECUTE</span> <span class="k">FUNCTION</span> <span class="n">update_message_search_vector</span><span class="p">();</span>
</pre></td></tr></tbody></table></div></code></pre></div></div><hr />
<h2 id="7-message-analytics-and-reporting">
  
  
    <a href="#7-message-analytics-and-reporting" class="anchor-heading" aria-labelledby="7-message-analytics-and-reporting"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7. Message Analytics and Reporting
  
  
</h2>
    
<h3 id="overview-7">
  
  
    <a href="#overview-7" class="anchor-heading" aria-labelledby="overview-7"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview
  
  
</h3>
    
<p>Provide analytics and reporting capabilities for message traffic, patterns, and metrics.</p>
<h3 id="architecture-6">
  
  
    <a href="#architecture-6" class="anchor-heading" aria-labelledby="architecture-6"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Architecture
  
  
</h3>
    

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>Analytics Engine
    │
    ├── Metrics Collection
    │   ├── Message counts
    │   ├── Traffic patterns
    │   └── Error rates
    │
    ├── Aggregations
    │   ├── Time-based
    │   ├── DID-based
    │   └── Type-based
    │
    └── Reporting
        ├── Dashboards
        └── Exports
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h3 id="implementation-steps-6">
  
  
    <a href="#implementation-steps-6" class="anchor-heading" aria-labelledby="implementation-steps-6"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Implementation Steps
  
  
</h3>
    
<h4 id="step-1-create-analytics-service">
  
  
    <a href="#step-1-create-analytics-service" class="anchor-heading" aria-labelledby="step-1-create-analytics-service"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1: Create Analytics Service
  
  
</h4>
    
<p><strong>File</strong>: <code class="language-plaintext highlighter-rouge">credentials/plugins/didcomm/src/main/kotlin/com/trustweave/credential/didcomm/storage/analytics/MessageAnalytics.kt</code></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="nn">com.trustweave.credential.didcomm.storage.analytics</span>

<span class="k">import</span> <span class="nn">com.trustweave.credential.didcomm.models.DidCommMessage</span>
<span class="k">import</span> <span class="nn">java.time.Instant</span>
<span class="k">import</span> <span class="nn">java.time.temporal.ChronoUnit</span>

<span class="cm">/**
 * Message analytics and reporting.
 */</span>
<span class="kd">interface</span> <span class="nc">MessageAnalytics</span> <span class="p">{</span>
    <span class="cm">/**
     * Gets message statistics for a time period.
     */</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getStatistics</span><span class="p">(</span>
        <span class="n">startTime</span><span class="p">:</span> <span class="nc">Instant</span><span class="p">,</span>
        <span class="n">endTime</span><span class="p">:</span> <span class="nc">Instant</span><span class="p">,</span>
        <span class="n">groupBy</span><span class="p">:</span> <span class="nc">GroupBy</span> <span class="p">=</span> <span class="nc">GroupBy</span><span class="p">.</span><span class="nc">HOUR</span>
    <span class="p">):</span> <span class="nc">MessageStatistics</span>
    
    <span class="cm">/**
     * Gets traffic patterns.
     */</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getTrafficPatterns</span><span class="p">(</span>
        <span class="n">startTime</span><span class="p">:</span> <span class="nc">Instant</span><span class="p">,</span>
        <span class="n">endTime</span><span class="p">:</span> <span class="nc">Instant</span>
    <span class="p">):</span> <span class="nc">TrafficPatterns</span>
    
    <span class="cm">/**
     * Gets top DIDs by message count.
     */</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getTopDids</span><span class="p">(</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">startTime</span><span class="p">:</span> <span class="nc">Instant</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
        <span class="n">endTime</span><span class="p">:</span> <span class="nc">Instant</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
    <span class="p">):</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">DidStatistics</span><span class="p">&gt;</span>
    
    <span class="cm">/**
     * Gets message type distribution.
     */</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getTypeDistribution</span><span class="p">(</span>
        <span class="n">startTime</span><span class="p">:</span> <span class="nc">Instant</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
        <span class="n">endTime</span><span class="p">:</span> <span class="nc">Instant</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
    <span class="p">):</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">Int</span><span class="p">&gt;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="kd">class</span> <span class="nc">GroupBy</span> <span class="p">{</span>
    <span class="nc">HOUR</span><span class="p">,</span> <span class="nc">DAY</span><span class="p">,</span> <span class="nc">WEEK</span><span class="p">,</span> <span class="nc">MONTH</span>
<span class="p">}</span>

<span class="kd">data class</span> <span class="nc">MessageStatistics</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">totalMessages</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">sentMessages</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">receivedMessages</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">averageMessageSize</span><span class="p">:</span> <span class="nc">Long</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">timeSeries</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">TimeSeriesPoint</span><span class="p">&gt;</span>
<span class="p">)</span>

<span class="kd">data class</span> <span class="nc">TimeSeriesPoint</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">timestamp</span><span class="p">:</span> <span class="nc">Instant</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">count</span><span class="p">:</span> <span class="nc">Int</span>
<span class="p">)</span>

<span class="kd">data class</span> <span class="nc">TrafficPatterns</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">peakHours</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;,</span>
    <span class="kd">val</span> <span class="py">averageMessagesPerHour</span><span class="p">:</span> <span class="nc">Double</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">busiestDay</span><span class="p">:</span> <span class="nc">String</span>
<span class="p">)</span>

<span class="kd">data class</span> <span class="nc">DidStatistics</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">did</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">messageCount</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">sentCount</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">receivedCount</span><span class="p">:</span> <span class="nc">Int</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h4 id="step-2-implement-analytics">
  
  
    <a href="#step-2-implement-analytics" class="anchor-heading" aria-labelledby="step-2-implement-analytics"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2: Implement Analytics
  
  
</h4>
    
<p><strong>File</strong>: <code class="language-plaintext highlighter-rouge">credentials/plugins/didcomm/src/main/kotlin/com/trustweave/credential/didcomm/storage/analytics/PostgresMessageAnalytics.kt</code></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * PostgreSQL-based analytics implementation.
 */</span>
<span class="kd">class</span> <span class="nc">PostgresMessageAnalytics</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">storage</span><span class="p">:</span> <span class="nc">PostgresDidCommMessageStorage</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">MessageAnalytics</span> <span class="p">{</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getStatistics</span><span class="p">(</span>
        <span class="n">startTime</span><span class="p">:</span> <span class="nc">Instant</span><span class="p">,</span>
        <span class="n">endTime</span><span class="p">:</span> <span class="nc">Instant</span><span class="p">,</span>
        <span class="n">groupBy</span><span class="p">:</span> <span class="nc">GroupBy</span>
    <span class="p">):</span> <span class="nc">MessageStatistics</span> <span class="p">{</span>
        <span class="c1">// Query database for statistics</span>
        <span class="c1">// Use SQL aggregations and GROUP BY</span>
        <span class="k">return</span> <span class="nc">MessageStatistics</span><span class="p">(</span>
            <span class="n">totalMessages</span> <span class="p">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">sentMessages</span> <span class="p">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">receivedMessages</span> <span class="p">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">averageMessageSize</span> <span class="p">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">timeSeries</span> <span class="p">=</span> <span class="nf">emptyList</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="p">}</span>
    
    <span class="c1">// Implement other methods...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div><hr />
<h2 id="8-key-rotation-automation">
  
  
    <a href="#8-key-rotation-automation" class="anchor-heading" aria-labelledby="8-key-rotation-automation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 8. Key Rotation Automation
  
  
</h2>
    
<h3 id="overview-8">
  
  
    <a href="#overview-8" class="anchor-heading" aria-labelledby="overview-8"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview
  
  
</h3>
    
<p>Automate key rotation for DIDComm keys to maintain security.</p>
<h3 id="architecture-7">
  
  
    <a href="#architecture-7" class="anchor-heading" aria-labelledby="architecture-7"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Architecture
  
  
</h3>
    

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>Key Rotation Manager
    │
    ├── Rotation Policy
    │   ├── Time-based (e.g., every 90 days)
    │   ├── Usage-based (e.g., after N uses)
    │   └── Manual trigger
    │
    ├── Rotation Process
    │   ├── Generate new key
    │   ├── Update DID document
    │   ├── Migrate messages
    │   └── Archive old key
    │
    └── Key Lifecycle
        ├── Active
        ├── Rotating
        └── Archived
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h3 id="implementation-steps-7">
  
  
    <a href="#implementation-steps-7" class="anchor-heading" aria-labelledby="implementation-steps-7"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Implementation Steps
  
  
</h3>
    
<h4 id="step-1-create-rotation-policy">
  
  
    <a href="#step-1-create-rotation-policy" class="anchor-heading" aria-labelledby="step-1-create-rotation-policy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1: Create Rotation Policy
  
  
</h4>
    
<p><strong>File</strong>: <code class="language-plaintext highlighter-rouge">credentials/plugins/didcomm/src/main/kotlin/com/trustweave/credential/didcomm/crypto/rotation/KeyRotationPolicy.kt</code></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="nn">com.trustweave.credential.didcomm.crypto.rotation</span>

<span class="k">import</span> <span class="nn">java.time.Instant</span>
<span class="k">import</span> <span class="nn">java.time.temporal.ChronoUnit</span>

<span class="cm">/**
 * Defines when keys should be rotated.
 */</span>
<span class="kd">interface</span> <span class="nc">KeyRotationPolicy</span> <span class="p">{</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">shouldRotate</span><span class="p">(</span><span class="n">keyId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">keyMetadata</span><span class="p">:</span> <span class="nc">KeyMetadata</span><span class="p">):</span> <span class="nc">Boolean</span>
<span class="p">}</span>

<span class="kd">data class</span> <span class="nc">KeyMetadata</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">keyId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">createdAt</span><span class="p">:</span> <span class="nc">Instant</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">lastUsedAt</span><span class="p">:</span> <span class="nc">Instant</span><span class="p">?,</span>
    <span class="kd">val</span> <span class="py">usageCount</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">0</span>
<span class="p">)</span>

<span class="cm">/**
 * Time-based rotation policy.
 */</span>
<span class="kd">class</span> <span class="nc">TimeBasedRotationPolicy</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">maxAgeDays</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">90</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">KeyRotationPolicy</span> <span class="p">{</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">shouldRotate</span><span class="p">(</span>
        <span class="n">keyId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
        <span class="n">keyMetadata</span><span class="p">:</span> <span class="nc">KeyMetadata</span>
    <span class="p">):</span> <span class="nc">Boolean</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">age</span> <span class="p">=</span> <span class="nc">ChronoUnit</span><span class="p">.</span><span class="nc">DAYS</span><span class="p">.</span><span class="nf">between</span><span class="p">(</span>
            <span class="n">keyMetadata</span><span class="p">.</span><span class="n">createdAt</span><span class="p">,</span>
            <span class="nc">Instant</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">age</span> <span class="p">&gt;=</span> <span class="n">maxAgeDays</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**
 * Usage-based rotation policy.
 */</span>
<span class="kd">class</span> <span class="nc">UsageBasedRotationPolicy</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">maxUsageCount</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">10000</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">KeyRotationPolicy</span> <span class="p">{</span>
    
    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">shouldRotate</span><span class="p">(</span>
        <span class="n">keyId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
        <span class="n">keyMetadata</span><span class="p">:</span> <span class="nc">KeyMetadata</span>
    <span class="p">):</span> <span class="nc">Boolean</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">keyMetadata</span><span class="p">.</span><span class="n">usageCount</span> <span class="p">&gt;=</span> <span class="n">maxUsageCount</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h4 id="step-2-create-rotation-manager">
  
  
    <a href="#step-2-create-rotation-manager" class="anchor-heading" aria-labelledby="step-2-create-rotation-manager"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2: Create Rotation Manager
  
  
</h4>
    
<p><strong>File</strong>: <code class="language-plaintext highlighter-rouge">credentials/plugins/didcomm/src/main/kotlin/com/trustweave/credential/didcomm/crypto/rotation/KeyRotationManager.kt</code></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="nn">com.trustweave.credential.didcomm.crypto.rotation</span>

<span class="k">import</span> <span class="nn">com.trustweave.credential.didcomm.crypto.secret.LocalKeyStore</span>
<span class="k">import</span> <span class="nn">com.trustweave.kms.KeyManagementService</span>
<span class="k">import</span> <span class="nn">org.didcommx.didcomm.secret.Secret</span>
<span class="k">import</span> <span class="nn">kotlinx.coroutines.Dispatchers</span>
<span class="k">import</span> <span class="nn">kotlinx.coroutines.withContext</span>

<span class="cm">/**
 * Manages key rotation for DIDComm keys.
 */</span>
<span class="kd">class</span> <span class="nc">KeyRotationManager</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">keyStore</span><span class="p">:</span> <span class="nc">LocalKeyStore</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">kms</span><span class="p">:</span> <span class="nc">KeyManagementService</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">policy</span><span class="p">:</span> <span class="nc">KeyRotationPolicy</span>
<span class="p">)</span> <span class="p">{</span>
    
    <span class="cm">/**
     * Checks and rotates keys if needed.
     */</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">checkAndRotate</span><span class="p">():</span> <span class="nc">RotationResult</span> <span class="p">=</span> <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">keysToRotate</span> <span class="p">=</span> <span class="nf">findKeysToRotate</span><span class="p">()</span>
        
        <span class="kd">val</span> <span class="py">results</span> <span class="p">=</span> <span class="n">keysToRotate</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="n">keyId</span> <span class="p">-&gt;</span>
            <span class="nf">rotateKey</span><span class="p">(</span><span class="n">keyId</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="nc">RotationResult</span><span class="p">(</span>
            <span class="n">rotatedCount</span> <span class="p">=</span> <span class="n">results</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
            <span class="n">results</span> <span class="p">=</span> <span class="n">results</span>
        <span class="p">)</span>
    <span class="p">}</span>
    
    <span class="cm">/**
     * Rotates a specific key.
     */</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">rotateKey</span><span class="p">(</span><span class="n">keyId</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">KeyRotationResult</span> <span class="p">=</span> <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 1. Get current key</span>
        <span class="kd">val</span> <span class="py">oldKey</span> <span class="p">=</span> <span class="n">keyStore</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">keyId</span><span class="p">)</span>
            <span class="o">?:</span> <span class="k">throw</span> <span class="nc">IllegalArgumentException</span><span class="p">(</span><span class="s">"Key not found: $keyId"</span><span class="p">)</span>
        
        <span class="c1">// 2. Generate new key</span>
        <span class="kd">val</span> <span class="py">newKeyId</span> <span class="p">=</span> <span class="nf">generateNewKeyId</span><span class="p">(</span><span class="n">keyId</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">newKey</span> <span class="p">=</span> <span class="nf">generateNewKey</span><span class="p">(</span><span class="n">newKeyId</span><span class="p">)</span>
        
        <span class="c1">// 3. Store new key</span>
        <span class="n">keyStore</span><span class="p">.</span><span class="nf">store</span><span class="p">(</span><span class="n">newKeyId</span><span class="p">,</span> <span class="n">newKey</span><span class="p">)</span>
        
        <span class="c1">// 4. Update DID document (if applicable)</span>
        <span class="nf">updateDidDocument</span><span class="p">(</span><span class="n">keyId</span><span class="p">,</span> <span class="n">newKeyId</span><span class="p">)</span>
        
        <span class="c1">// 5. Archive old key</span>
        <span class="nf">archiveOldKey</span><span class="p">(</span><span class="n">keyId</span><span class="p">,</span> <span class="n">oldKey</span><span class="p">)</span>
        
        <span class="nc">KeyRotationResult</span><span class="p">(</span>
            <span class="n">oldKeyId</span> <span class="p">=</span> <span class="n">keyId</span><span class="p">,</span>
            <span class="n">newKeyId</span> <span class="p">=</span> <span class="n">newKeyId</span><span class="p">,</span>
            <span class="n">success</span> <span class="p">=</span> <span class="k">true</span>
        <span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">findKeysToRotate</span><span class="p">():</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">allKeys</span> <span class="p">=</span> <span class="n">keyStore</span><span class="p">.</span><span class="nf">list</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">allKeys</span><span class="p">.</span><span class="nf">filter</span> <span class="p">{</span> <span class="n">keyId</span> <span class="p">-&gt;</span>
            <span class="kd">val</span> <span class="py">metadata</span> <span class="p">=</span> <span class="nf">getKeyMetadata</span><span class="p">(</span><span class="n">keyId</span><span class="p">)</span>
            <span class="n">policy</span><span class="p">.</span><span class="nf">shouldRotate</span><span class="p">(</span><span class="n">keyId</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getKeyMetadata</span><span class="p">(</span><span class="n">keyId</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">KeyMetadata</span> <span class="p">{</span>
        <span class="c1">// Get metadata from key store or separate metadata store</span>
        <span class="k">return</span> <span class="nc">KeyMetadata</span><span class="p">(</span>
            <span class="n">keyId</span> <span class="p">=</span> <span class="n">keyId</span><span class="p">,</span>
            <span class="n">createdAt</span> <span class="p">=</span> <span class="nc">Instant</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="nf">minus</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nc">ChronoUnit</span><span class="p">.</span><span class="nc">DAYS</span><span class="p">),</span>
            <span class="n">lastUsedAt</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
            <span class="n">usageCount</span> <span class="p">=</span> <span class="mi">0</span>
        <span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">generateNewKeyId</span><span class="p">(</span><span class="n">oldKeyId</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">String</span> <span class="p">{</span>
        <span class="c1">// Generate new key ID (e.g., increment version)</span>
        <span class="k">return</span> <span class="s">"$oldKeyId-v2"</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">generateNewKey</span><span class="p">(</span><span class="n">keyId</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">Secret</span> <span class="p">{</span>
        <span class="c1">// Generate new key using KMS</span>
        <span class="c1">// Implementation depends on key type</span>
        <span class="k">throw</span> <span class="nc">NotImplementedError</span><span class="p">(</span><span class="s">"Key generation to be implemented"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">updateDidDocument</span><span class="p">(</span><span class="n">oldKeyId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">newKeyId</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Update DID document with new key</span>
        <span class="c1">// Implementation depends on DID method</span>
    <span class="p">}</span>
    
    <span class="k">private</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">archiveOldKey</span><span class="p">(</span><span class="n">keyId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nc">Secret</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Archive old key (don't delete immediately)</span>
        <span class="c1">// Keep for decryption of old messages</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">data class</span> <span class="nc">RotationResult</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">rotatedCount</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">results</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">KeyRotationResult</span><span class="p">&gt;</span>
<span class="p">)</span>

<span class="kd">data class</span> <span class="nc">KeyRotationResult</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">oldKeyId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">newKeyId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">success</span><span class="p">:</span> <span class="nc">Boolean</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">error</span><span class="p">:</span> <span class="nc">String</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h4 id="step-3-scheduled-rotation">
  
  
    <a href="#step-3-scheduled-rotation" class="anchor-heading" aria-labelledby="step-3-scheduled-rotation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3: Scheduled Rotation
  
  
</h4>
    
<p><strong>File</strong>: <code class="language-plaintext highlighter-rouge">credentials/plugins/didcomm/src/main/kotlin/com/trustweave/credential/didcomm/crypto/rotation/ScheduledKeyRotation.kt</code></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * Scheduled key rotation service.
 */</span>
<span class="kd">class</span> <span class="nc">ScheduledKeyRotation</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">rotationManager</span><span class="p">:</span> <span class="nc">KeyRotationManager</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">interval</span><span class="p">:</span> <span class="n">java</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="nc">Duration</span> <span class="p">=</span> <span class="n">java</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="nc">Duration</span><span class="p">.</span><span class="nf">ofDays</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">private</span> <span class="kd">var</span> <span class="py">rotationJob</span><span class="p">:</span> <span class="n">kotlinx</span><span class="p">.</span><span class="n">coroutines</span><span class="p">.</span><span class="nc">Job</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
    
    <span class="k">fun</span> <span class="nf">start</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">rotationJob</span> <span class="p">=</span> <span class="n">kotlinx</span><span class="p">.</span><span class="n">coroutines</span><span class="p">.</span><span class="nc">CoroutineScope</span><span class="p">(</span><span class="n">kotlinx</span><span class="p">.</span><span class="n">coroutines</span><span class="p">.</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">Default</span><span class="p">).</span><span class="nf">launch</span> <span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="n">rotationManager</span><span class="p">.</span><span class="nf">checkAndRotate</span><span class="p">()</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">Exception</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// Log error, continue</span>
                <span class="p">}</span>
                <span class="n">kotlinx</span><span class="p">.</span><span class="n">coroutines</span><span class="p">.</span><span class="nf">delay</span><span class="p">(</span><span class="n">interval</span><span class="p">.</span><span class="nf">toMillis</span><span class="p">())</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">fun</span> <span class="nf">stop</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">rotationJob</span><span class="o">?.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div><hr />
<h2 id="implementation-timeline">
  
  
    <a href="#implementation-timeline" class="anchor-heading" aria-labelledby="implementation-timeline"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Implementation Timeline
  
  
</h2>
    
<h3 id="phase-1-core-enhancements-weeks-1-4">
  
  
    <a href="#phase-1-core-enhancements-weeks-1-4" class="anchor-heading" aria-labelledby="phase-1-core-enhancements-weeks-1-4"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Phase 1: Core Enhancements (Weeks 1-4)
  
  
</h3>
    
<ul>
  <li><strong>Week 1-2</strong>: EncryptedFileLocalKeyStore</li>
  <li><strong>Week 2-3</strong>: Message encryption at rest</li>
  <li><strong>Week 3-4</strong>: MongoDB storage</li>
</ul>
<h3 id="phase-2-scalability-weeks-5-8">
  
  
    <a href="#phase-2-scalability-weeks-5-8" class="anchor-heading" aria-labelledby="phase-2-scalability-weeks-5-8"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Phase 2: Scalability (Weeks 5-8)
  
  
</h3>
    
<ul>
  <li><strong>Week 5-6</strong>: Message archiving</li>
  <li><strong>Week 7-8</strong>: Message replication</li>
</ul>
<h3 id="phase-3-advanced-features-weeks-9-12">
  
  
    <a href="#phase-3-advanced-features-weeks-9-12" class="anchor-heading" aria-labelledby="phase-3-advanced-features-weeks-9-12"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Phase 3: Advanced Features (Weeks 9-12)
  
  
</h3>
    
<ul>
  <li><strong>Week 9-10</strong>: Advanced search</li>
  <li><strong>Week 11</strong>: Analytics and reporting</li>
  <li><strong>Week 12</strong>: Key rotation automation</li>
</ul>
<h2 id="dependencies-1">
  
  
    <a href="#dependencies-1" class="anchor-heading" aria-labelledby="dependencies-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Dependencies
  
  
</h2>
    
<h3 id="new-dependencies-required">
  
  
    <a href="#new-dependencies-required" class="anchor-heading" aria-labelledby="new-dependencies-required"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> New Dependencies Required
  
  
</h3>
    

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c1">// MongoDB</span>
<span class="nf">implementation</span><span class="p">(</span><span class="s">"org.mongodb:mongodb-driver-kotlin-coroutine:4.11.0"</span><span class="p">)</span>

<span class="c1">// AWS S3 (for archiving)</span>
<span class="nf">implementation</span><span class="p">(</span><span class="s">"software.amazon.awssdk:s3:2.20.0"</span><span class="p">)</span>

<span class="c1">// Elasticsearch (optional, for advanced search)</span>
<span class="nf">implementation</span><span class="p">(</span><span class="s">"co.elastic.clients:elasticsearch-java:8.11.0"</span><span class="p">)</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
<h2 id="testing-strategy-1">
  
  
    <a href="#testing-strategy-1" class="anchor-heading" aria-labelledby="testing-strategy-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Testing Strategy
  
  
</h2>
    
<h3 id="unit-tests">
  
  
    <a href="#unit-tests" class="anchor-heading" aria-labelledby="unit-tests"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Unit Tests
  
  
</h3>
    
<ul>
  <li>Encryption/decryption tests</li>
  <li>Storage operation tests</li>
  <li>Search functionality tests</li>
  <li>Analytics calculation tests</li>
</ul>
<h3 id="integration-tests">
  
  
    <a href="#integration-tests" class="anchor-heading" aria-labelledby="integration-tests"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Integration Tests
  
  
</h3>
    
<ul>
  <li>Database integration tests</li>
  <li>Cloud storage integration tests</li>
  <li>Replication tests</li>
  <li>Performance tests</li>
</ul>
<h3 id="security-tests">
  
  
    <a href="#security-tests" class="anchor-heading" aria-labelledby="security-tests"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Security Tests
  
  
</h3>
    
<ul>
  <li>Encryption strength tests</li>
  <li>Key access control tests</li>
  <li>Audit logging tests</li>
</ul>
<h2 id="monitoring--observability">
  
  
    <a href="#monitoring--observability" class="anchor-heading" aria-labelledby="monitoring--observability"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Monitoring &amp; Observability
  
  
</h2>
    
<h3 id="metrics-to-track">
  
  
    <a href="#metrics-to-track" class="anchor-heading" aria-labelledby="metrics-to-track"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Metrics to Track
  
  
</h3>
    
<ul>
  <li>Message storage latency</li>
  <li>Archive operation duration</li>
  <li>Replication lag</li>
  <li>Search query performance</li>
  <li>Key rotation success rate</li>
  <li>Encryption/decryption performance</li>
</ul>
<h3 id="alerts">
  
  
    <a href="#alerts" class="anchor-heading" aria-labelledby="alerts"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Alerts
  
  
</h3>
    
<ul>
  <li>Replication failures</li>
  <li>Archive failures</li>
  <li>Key rotation failures</li>
  <li>High storage usage</li>
  <li>Search performance degradation</li>
</ul>
<h2 id="security-considerations">
  
  
    <a href="#security-considerations" class="anchor-heading" aria-labelledby="security-considerations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Security Considerations
  
  
</h2>
    

<ol>
  <li><strong>Key Management</strong>: Master keys must be stored securely (HSM, cloud KMS)</li>
  <li><strong>Access Control</strong>: Implement RBAC for storage operations</li>
  <li><strong>Audit Logging</strong>: Log all key access and rotation operations</li>
  <li><strong>Encryption</strong>: Use strong encryption (AES-256-GCM)</li>
  <li><strong>Key Rotation</strong>: Regular rotation schedule</li>
  <li><strong>Backup Encryption</strong>: Encrypt backups</li>
</ol>
<h2 id="performance-considerations">
  
  
    <a href="#performance-considerations" class="anchor-heading" aria-labelledby="performance-considerations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Performance Considerations
  
  
</h2>
    

<ol>
  <li><strong>Indexing</strong>: Proper indexes for all query patterns</li>
  <li><strong>Caching</strong>: Cache frequently accessed data</li>
  <li><strong>Batch Operations</strong>: Batch archive and replication operations</li>
  <li><strong>Connection Pooling</strong>: Use connection pools for databases</li>
  <li><strong>Async Operations</strong>: Use async for non-critical operations</li>
</ol>
<h2 id="migration-strategy">
  
  
    <a href="#migration-strategy" class="anchor-heading" aria-labelledby="migration-strategy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Migration Strategy
  
  
</h2>
    

<ol>
  <li><strong>Gradual Rollout</strong>: Implement features incrementally</li>
  <li><strong>Backward Compatibility</strong>: Maintain compatibility with existing data</li>
  <li><strong>Data Migration</strong>: Scripts for migrating existing data</li>
  <li><strong>Rollback Plan</strong>: Ability to rollback if issues occur</li>
</ol>

          

          
            
          
        </main>
        

  <hr>
  <footer>
    

    <!-- Hidden template for footer injection -->
<div id="footer-template" style="display: none;">
  <!-- Site Footer - Consistent across all pages -->
<footer class="site-footer">
    <div class="footer-content">
        <div class="footer-links">
            <a href="/trustweave/">Home</a>
            <a href="/trustweave/getting-started/README/">Documentation</a>
            <a href="https://github.com/geoknoesis/TrustWeave" target="_blank">GitHub</a>
            <a href="/trustweave/partnership/">Partners</a>
            <a href="https://github.com/geoknoesis/TrustWeave/blob/main/docs/README.md" target="_blank">Docs</a>
            <a href="https://github.com/geoknoesis/TrustWeave/blob/main/LICENSE" target="_blank">License</a>
            <a href="https://www.geoknoesis.com" target="_blank">Geoknoesis LLC</a>
        </div>
        <p class="footer-text">Made with ❤️ by Geoknoesis LLC</p>
    </div>
</footer>


</div>
<script>
  // Move footer from template to body bottom and make it full width
  document.addEventListener('DOMContentLoaded', function() {
    const template = document.getElementById('footer-template');
    if (template) {
      const footer = template.querySelector('.site-footer');
      if (footer) {
        // Move footer to body level (outside of any containers)
        document.body.appendChild(footer);
        template.remove();
        
        // Ensure footer spans full width by removing any parent constraints
        footer.style.position = 'relative';
        footer.style.width = '100vw';
        footer.style.marginLeft = 'calc(-50vw + 50%)';
        footer.style.marginRight = 'calc(-50vw + 50%)';
      }
    }
  });
</script>


    
  </footer>


      </div>
    </div>
    
      

<div class="search-overlay"></div>

    
  </div>

  
    





<script type="module">
  
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.esm.min.mjs';
  

  var config = {}
;
  mermaid.initialize(config);
  mermaid.run({
    querySelector: '.language-mermaid',
  });
</script>



  
</body>
</html>

